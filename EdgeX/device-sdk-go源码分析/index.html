<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>device-sdk-go源码分析 - Cindy</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#f7f7f7"><meta name="application-name" content="Cindy Page"><meta name="msapplication-TileImage" content="https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/favicon.svg"><meta name="msapplication-TileColor" content="#f7f7f7"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Cindy Page"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="device-sdk-go源码分析device-sdk-go项目目录结构1234567891011121314151617181920212223242526272829303132333435363738├─.github│  └─ISSUE_TEMPLATE├─bin├─example│  ├─cmd│  │  └─device-simple│  │      └─res│  │"><meta property="og:type" content="blog"><meta property="og:title" content="device-sdk-go源码分析"><meta property="og:url" content="http://caixindi.github.io/EdgeX/device-sdk-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="Cindy"><meta property="og:description" content="device-sdk-go源码分析device-sdk-go项目目录结构1234567891011121314151617181920212223242526272829303132333435363738├─.github│  └─ISSUE_TEMPLATE├─bin├─example│  ├─cmd│  │  └─device-simple│  │      └─res│  │"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://caixindi.github.io/img/og_image.png"><meta property="article:published_time" content="2021-12-26T16:00:00.000Z"><meta property="article:author" content="Cindy"><meta property="article:tag" content="EdgeX概念"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://caixindi.github.io/EdgeX/device-sdk-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"},"headline":"device-sdk-go源码分析","image":["http://caixindi.github.io/img/og_image.png"],"datePublished":"2021-12-26T16:00:00.000Z","author":{"@type":"Person","name":"Cindy"},"publisher":{"@type":"Organization","name":"Cindy","logo":{"@type":"ImageObject","url":"https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/cindy.svg"}},"description":"device-sdk-go源码分析device-sdk-go项目目录结构1234567891011121314151617181920212223242526272829303132333435363738├─.github│  └─ISSUE_TEMPLATE├─bin├─example│  ├─cmd│  │  └─device-simple│  │      └─res│  │"}</script><link rel="canonical" href="http://caixindi.github.io/EdgeX/device-sdk-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="icon" href="https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-72437521-5" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-72437521-5');</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.1.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/cindy.svg" alt="Cindy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-26T16:00:00.000Z" title="12/27/2021, 12:00:00 AM">2021-12-27</time>发表</span><span class="level-item"><a class="link-muted" href="/categories/EdgeX/">EdgeX</a></span><span class="level-item">1 小时读完 (大约9263个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">device-sdk-go源码分析</h1><div class="content"><h3 id="device-sdk-go源码分析"><a href="#device-sdk-go源码分析" class="headerlink" title="device-sdk-go源码分析"></a>device-sdk-go源码分析</h3><h4 id="device-sdk-go项目目录结构"><a href="#device-sdk-go项目目录结构" class="headerlink" title="device-sdk-go项目目录结构"></a>device-sdk-go项目目录结构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">├─.github</span><br><span class="line">│  └─ISSUE_TEMPLATE</span><br><span class="line">├─bin</span><br><span class="line">├─example</span><br><span class="line">│  ├─cmd</span><br><span class="line">│  │  └─device-simple</span><br><span class="line">│  │      └─res</span><br><span class="line">│  │          ├─devices</span><br><span class="line">│  │          └─profiles</span><br><span class="line">│  ├─config</span><br><span class="line">│  └─driver</span><br><span class="line">├─internal</span><br><span class="line">│  ├─application</span><br><span class="line">│  ├─autodiscovery</span><br><span class="line">│  ├─autoevent</span><br><span class="line">│  ├─cache</span><br><span class="line">│  ├─clients</span><br><span class="line">│  ├─common</span><br><span class="line">│  ├─config</span><br><span class="line">│  ├─container</span><br><span class="line">│  ├─controller</span><br><span class="line">│  │  └─http</span><br><span class="line">│  │      └─correlation</span><br><span class="line">│  ├─messaging</span><br><span class="line">│  ├─provision</span><br><span class="line">│  ├─telemetry</span><br><span class="line">│  └─transformer</span><br><span class="line">├─openapi</span><br><span class="line">│  └─v2</span><br><span class="line">├─pkg</span><br><span class="line">│  ├─models</span><br><span class="line">│  │  └─mocks</span><br><span class="line">│  ├─service</span><br><span class="line">│  └─startup</span><br><span class="line">└─snap</span><br><span class="line">    ├─hooks</span><br><span class="line">    └─local</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>接下来以官方提供的example项目包为例，分析device-sdk-go的项目结构和相关功能。</p>
<p>目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├─cmd</span><br><span class="line">│  └─device-simple</span><br><span class="line">│      └─res</span><br><span class="line">│          ├─devices</span><br><span class="line">│          └─profiles</span><br><span class="line">├─config</span><br><span class="line">└─driver</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="cmd文件夹"><a href="#cmd文件夹" class="headerlink" title="cmd文件夹"></a>cmd文件夹</h5><p><code>main.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -*- Mode: Go; indent-tabs-mode: t -*-</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Copyright (C) 2017-2018 Canonical Ltd</span></span><br><span class="line"><span class="comment">// Copyright (C) 2018-2019 IOTech Ltd</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This package provides a simple example of a device service.</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="comment">//导入包</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/example/driver&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/pkg/startup&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义常量 服务名称</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	serviceName <span class="type">string</span> = <span class="string">&quot;device-simple&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	sd := driver.SimpleDriver&#123;&#125;  <span class="comment">//初始化SimpleDriver结构体</span></span><br><span class="line">	startup.Bootstrap(serviceName, device.Version, &amp;sd)  <span class="comment">//通过引导程序启动设备服务</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>configuration.toml</code></p>
<ul>
<li>项目配置文件</li>
<li>描述当前device-service的ip，port以及所依赖的各个EdgeX微服务的配置信息等</li>
</ul>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Writable]</span></span><br><span class="line"><span class="attr">LogLevel</span> = <span class="string">&quot;INFO&quot;</span></span><br><span class="line">  <span class="comment"># 非安全模式下的配置</span></span><br><span class="line">  <span class="comment"># Example InsecureSecrets configuration that simulates SecretStore for when EDGEX_SECURITY_SECRET_STORE=false</span></span><br><span class="line">  <span class="comment"># InsecureSecrets are required for when Redis is used for message bus</span></span><br><span class="line">  <span class="section">[Writable.InsecureSecrets]</span></span><br><span class="line">    <span class="section">[Writable.InsecureSecrets.DB]</span></span><br><span class="line">    <span class="attr">path</span> = <span class="string">&quot;redisdb&quot;</span></span><br><span class="line">      <span class="section">[Writable.InsecureSecrets.DB.Secrets]</span></span><br><span class="line">      <span class="attr">username</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">password</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">HealthCheckInterval</span> = <span class="string">&quot;10s&quot;</span> <span class="comment">#健康健康间隔</span></span><br><span class="line"><span class="attr">Host</span> = <span class="string">&quot;localhost&quot;</span> </span><br><span class="line"><span class="attr">Port</span> = <span class="number">59999</span> <span class="comment"># Device serivce are assigned the 599xx range</span></span><br><span class="line"><span class="attr">ServerBindAddr</span> = <span class="string">&quot;&quot;</span>  <span class="comment"># blank value defaults to Service.Host value</span></span><br><span class="line"><span class="attr">StartupMsg</span> = <span class="string">&quot;device simple started&quot;</span></span><br><span class="line"><span class="comment"># MaxRequestSize limit the request body size in byte of put command</span></span><br><span class="line"><span class="attr">MaxRequestSize</span> = <span class="number">0</span> <span class="comment"># value 0 unlimit the request size.</span></span><br><span class="line"><span class="attr">RequestTimeout</span> = <span class="string">&quot;20s&quot;</span></span><br><span class="line">  <span class="section">[Service.CORSConfiguration]</span></span><br><span class="line">  <span class="attr">EnableCORS</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">CORSAllowCredentials</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">CORSAllowedOrigin</span> = <span class="string">&quot;https://localhost&quot;</span></span><br><span class="line">  <span class="attr">CORSAllowedMethods</span> = <span class="string">&quot;GET, POST, PUT, PATCH, DELETE&quot;</span></span><br><span class="line">  <span class="attr">CORSAllowedHeaders</span> = <span class="string">&quot;Authorization, Accept, Accept-Language, Content-Language, Content-Type, X-Correlation-ID&quot;</span></span><br><span class="line">  <span class="attr">CORSExposeHeaders</span> = <span class="string">&quot;Cache-Control, Content-Language, Content-Length, Content-Type, Expires, Last-Modified, Pragma, X-Correlation-ID&quot;</span></span><br><span class="line">  <span class="attr">CORSMaxAge</span> = <span class="number">3600</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Registry]</span></span><br><span class="line"><span class="attr">Host</span> = <span class="string">&quot;localhost&quot;</span></span><br><span class="line"><span class="attr">Port</span> = <span class="number">8500</span></span><br><span class="line"><span class="attr">Type</span> = <span class="string">&quot;consul&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Clients]</span></span><br><span class="line">  <span class="section">[Clients.core-data]</span></span><br><span class="line">  <span class="attr">Protocol</span> = <span class="string">&quot;http&quot;</span></span><br><span class="line">  <span class="attr">Host</span> = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">  <span class="attr">Port</span> = <span class="number">59880</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[Clients.core-metadata]</span></span><br><span class="line">  <span class="attr">Protocol</span> = <span class="string">&quot;http&quot;</span></span><br><span class="line">  <span class="attr">Host</span> = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">  <span class="attr">Port</span> = <span class="number">59881</span></span><br><span class="line"></span><br><span class="line"><span class="section">[MessageQueue]</span></span><br><span class="line"><span class="attr">Protocol</span> = <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="attr">Host</span> = <span class="string">&quot;localhost&quot;</span></span><br><span class="line"><span class="attr">Port</span> = <span class="number">6379</span></span><br><span class="line"><span class="attr">Type</span> = <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="attr">AuthMode</span> = <span class="string">&quot;usernamepassword&quot;</span>  <span class="comment"># required for redis messagebus (secure or insecure).</span></span><br><span class="line"><span class="attr">SecretName</span> = <span class="string">&quot;redisdb&quot;</span></span><br><span class="line"><span class="attr">PublishTopicPrefix</span> = <span class="string">&quot;edgex/events/device&quot;</span> <span class="comment"># /&lt;device-profile-name&gt;/&lt;device-name&gt;/&lt;source-name&gt; will be added to this Publish Topic prefix</span></span><br><span class="line">  <span class="section">[MessageQueue.Optional]</span></span><br><span class="line">  <span class="comment"># Default MQTT Specific options that need to be here to enable environment variable overrides of them</span></span><br><span class="line">  <span class="comment"># Client Identifiers</span></span><br><span class="line">  <span class="attr">ClientId</span> = <span class="string">&quot;device-simple&quot;</span></span><br><span class="line">  <span class="comment"># Connection information</span></span><br><span class="line">  <span class="attr">Qos</span> = <span class="string">&quot;0&quot;</span> <span class="comment"># Quality of Sevice values are 0 (At most once), 1 (At least once) or 2 (Exactly once)</span></span><br><span class="line">  <span class="attr">KeepAlive</span> = <span class="string">&quot;10&quot;</span> <span class="comment"># Seconds (must be 2 or greater)</span></span><br><span class="line">  <span class="attr">Retained</span> = <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="attr">AutoReconnect</span> = <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">ConnectTimeout</span> = <span class="string">&quot;5&quot;</span> <span class="comment"># Seconds</span></span><br><span class="line">  <span class="attr">SkipCertVerify</span> = <span class="string">&quot;false&quot;</span> <span class="comment"># Only used if Cert/Key file or Cert/Key PEMblock are specified</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example SecretStore configuration.</span></span><br><span class="line"><span class="comment"># Only used when EDGEX_SECURITY_SECRET_STORE=true</span></span><br><span class="line"><span class="comment"># Must also add `ADD_SECRETSTORE_TOKENS: &quot;device-simple&quot;` to vault-worker environment so it generates</span></span><br><span class="line"><span class="comment"># the token and secret store in vault for &quot;device-simple&quot;</span></span><br><span class="line"><span class="section">[SecretStore]</span></span><br><span class="line"><span class="attr">Type</span> = <span class="string">&quot;vault&quot;</span></span><br><span class="line"><span class="attr">Host</span> = <span class="string">&quot;localhost&quot;</span></span><br><span class="line"><span class="attr">Port</span> = <span class="number">8200</span></span><br><span class="line"><span class="attr">Path</span> = <span class="string">&quot;device-simple/&quot;</span></span><br><span class="line"><span class="attr">Protocol</span> = <span class="string">&quot;http&quot;</span></span><br><span class="line"><span class="attr">RootCaCertPath</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">ServerName</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">SecretsFile</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="attr">DisableScrubSecretsFile</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">TokenFile</span> = <span class="string">&quot;/tmp/edgex/secrets/device-simple/secrets-token.json&quot;</span></span><br><span class="line">  <span class="section">[SecretStore.Authentication]</span></span><br><span class="line">  <span class="attr">AuthType</span> = <span class="string">&quot;X-Vault-Token&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Device]</span></span><br><span class="line">  <span class="attr">DataTransform</span> = <span class="literal">true</span></span><br><span class="line">  <span class="attr">MaxCmdOps</span> = <span class="number">128</span></span><br><span class="line">  <span class="attr">MaxCmdValueLen</span> = <span class="number">256</span></span><br><span class="line">  <span class="attr">ProfilesDir</span> = <span class="string">&quot;./res/profiles&quot;</span></span><br><span class="line">  <span class="attr">DevicesDir</span> = <span class="string">&quot;./res/devices&quot;</span></span><br><span class="line">  <span class="attr">UpdateLastConnected</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">AsyncBufferSize</span> = <span class="number">1</span></span><br><span class="line">  <span class="attr">EnableAsyncReadings</span> = <span class="literal">true</span></span><br><span class="line">  <span class="attr">Labels</span> = []</span><br><span class="line">  <span class="attr">UseMessageBus</span> = <span class="literal">true</span></span><br><span class="line">  <span class="section">[Device.Discovery]</span></span><br><span class="line">    <span class="attr">Enabled</span> = <span class="literal">false</span></span><br><span class="line">    <span class="attr">Interval</span> = <span class="string">&quot;30s&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example structured custom configuration</span></span><br><span class="line"><span class="section">[SimpleCustom]</span></span><br><span class="line"><span class="attr">OnImageLocation</span> = <span class="string">&quot;./res/on.png&quot;</span></span><br><span class="line"><span class="attr">OffImageLocation</span> = <span class="string">&quot;./res/off.jpg&quot;</span></span><br><span class="line">  <span class="section">[SimpleCustom.Writable]</span></span><br><span class="line">  <span class="attr">DiscoverSleepDurationSecs</span> = <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="config文件夹"><a href="#config文件夹" class="headerlink" title="config文件夹"></a>config文件夹</h5><p><code>configuration.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//此文件包含了可以从服务的configuration.toml加载的配置示例</span></span><br><span class="line"><span class="comment">//或者是配置提供程序，又名consul</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果要在configuration.toml中使用自定义配置类型</span></span><br><span class="line"><span class="comment">//那么在configuration.toml的顶级配置名须是本文件中最外部结构名</span></span><br><span class="line"><span class="comment">//比如这个示例的 SimpleCustom</span></span><br><span class="line"><span class="keyword">type</span> ServiceConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	SimpleCustom SimpleCustomConfig</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SimpleCustomConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	OffImageLocation <span class="type">string</span></span><br><span class="line">	OnImageLocation  <span class="type">string</span></span><br><span class="line">	Writable         SimpleWritable</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SimpleWritable <span class="keyword">struct</span> &#123;</span><br><span class="line">	DiscoverSleepDurationSecs <span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从接受到的原始数据更新服务的完整配置</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sw *ServiceConfig)</span></span> UpdateFromRaw(rawConfig <span class="keyword">interface</span>&#123;&#125;) <span class="type">bool</span> &#123;</span><br><span class="line">	configuration, ok := rawConfig.(*ServiceConfig)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span> <span class="comment">//errors.New(&quot;unable to cast raw config to type &#x27;ServiceConfig&#x27;&quot;)</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*sw = *configuration</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确保自定义配置都有正确的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(scc *SimpleCustomConfig)</span></span> Validate() <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(scc.OnImageLocation) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;SimpleCustom.OnImageLocation configuration setting can not be blank&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(scc.OffImageLocation) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;SimpleCustom.OffImageLocation configuration setting can not be blank&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> scc.Writable.DiscoverSleepDurationSecs &lt; <span class="number">10</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.New(<span class="string">&quot;SimpleCustom.Writable.DiscoverSleepDurationSecs configuration setting must be 10 or greater&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>driver文件夹</p>
<p><code>simpledriver.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个包提供了协议驱动接口的简单实现示例</span></span><br><span class="line"><span class="keyword">package</span> driver</span><br><span class="line"><span class="comment">//导入包</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;image&quot;</span></span><br><span class="line">	<span class="string">&quot;image/jpeg&quot;</span></span><br><span class="line">	<span class="string">&quot;image/png&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;reflect&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/clients/logger&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/common&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/models&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/example/config&quot;</span></span><br><span class="line">	sdkModels <span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/pkg/models&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/pkg/service&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//简单驱动结构</span></span><br><span class="line"><span class="keyword">type</span> SimpleDriver <span class="keyword">struct</span> &#123;</span><br><span class="line">	lc            logger.LoggingClient   <span class="comment">//日志客户端</span></span><br><span class="line">	asyncCh       <span class="keyword">chan</span>&lt;- *sdkModels.AsyncValues  <span class="comment">//用于通过 ProtocolDrivers 异步发送设备读数的结构</span></span><br><span class="line">	deviceCh      <span class="keyword">chan</span>&lt;- []sdkModels.DiscoveredDevice <span class="comment">//定义找到一个设备所需的信息</span></span><br><span class="line">	switchButton  <span class="type">bool</span> <span class="comment">//开关按钮</span></span><br><span class="line">	xRotation     <span class="type">int32</span> <span class="comment">//x轴旋转速度</span></span><br><span class="line">	yRotation     <span class="type">int32</span> <span class="comment">//y轴旋转速度</span></span><br><span class="line">	zRotation     <span class="type">int32</span> <span class="comment">//z轴旋转速度</span></span><br><span class="line">	counter       <span class="keyword">interface</span>&#123;&#125; <span class="comment">//计数器</span></span><br><span class="line">	serviceConfig *config.ServiceConfig  <span class="comment">//自定义配置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取图片</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getImageBytes</span><span class="params">(imgFile <span class="type">string</span>, buf *bytes.Buffer)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// 从文件中读取图片</span></span><br><span class="line">	img, err := os.Open(imgFile)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> img.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解码，判断图片类型</span></span><br><span class="line">	imageData, imageType, err := image.Decode(img)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 当前文件任务结束，重置文件pointer</span></span><br><span class="line">	img.Seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> imageType == <span class="string">&quot;jpeg&quot;</span> &#123;</span><br><span class="line">		err = jpeg.Encode(buf, imageData, <span class="literal">nil</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> imageType == <span class="string">&quot;png&quot;</span> &#123;</span><br><span class="line">		err = png.Encode(buf, imageData)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为设备服务执行特定于协议的初始化</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> Initialize(lc logger.LoggingClient, asyncCh <span class="keyword">chan</span>&lt;- *sdkModels.AsyncValues, deviceCh <span class="keyword">chan</span>&lt;- []sdkModels.DiscoveredDevice) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">//为每个成员赋值</span></span><br><span class="line">	s.lc = lc</span><br><span class="line">	s.asyncCh = asyncCh</span><br><span class="line">	s.deviceCh = deviceCh</span><br><span class="line">    <span class="comment">//自定义服务配置</span></span><br><span class="line">	s.serviceConfig = &amp;config.ServiceConfig&#123;&#125;</span><br><span class="line">    <span class="comment">//计数器内容为map结构 key类型为string value类型为interface&#123;&#125;</span></span><br><span class="line">	s.counter = <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="string">&quot;f1&quot;</span>: <span class="string">&quot;ABC&quot;</span>,</span><br><span class="line">		<span class="string">&quot;f2&quot;</span>: <span class="number">123</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//service.RunningService() 返回设备服务</span></span><br><span class="line">    <span class="comment">//在&quot;github.com/edgexfoundry/device-sdk-go/v2/pkg/service&quot;中</span></span><br><span class="line">    <span class="comment">//定义了    var(</span></span><br><span class="line">    <span class="comment">//          ds *DeviceService</span></span><br><span class="line">    <span class="comment">//          )</span></span><br><span class="line">	ds := service.RunningService()</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//加载自定义服务配置</span></span><br><span class="line">	<span class="keyword">if</span> err := ds.LoadCustomConfig(s.serviceConfig, <span class="string">&quot;SimpleCustom&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to load &#x27;SimpleCustom&#x27; custom configuration: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//输出当前自定义配置</span></span><br><span class="line">	lc.Infof(<span class="string">&quot;Custom config is: %v&quot;</span>, s.serviceConfig.SimpleCustom)</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//确保自定义配置具有正确的值</span></span><br><span class="line">	<span class="keyword">if</span> err := s.serviceConfig.SimpleCustom.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;&#x27;SimpleCustom&#x27; custom configuration validation failed: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//启用go-mod-bootstrap中的配置处理器监听对自定义配置部分的更改</span></span><br><span class="line">    <span class="comment">//注意LoadCustomConfig必须在此方法前调用，因为在LoadCustomConfig方法内生成了configProcessor实例</span></span><br><span class="line">    <span class="comment">//所需传入的三个参数分别为需要监听的配置内容(可写的),名称,回调函数</span></span><br><span class="line">	<span class="keyword">if</span> err := ds.ListenForCustomConfigChanges(</span><br><span class="line">		&amp;s.serviceConfig.SimpleCustom.Writable,</span><br><span class="line">		<span class="string">&quot;SimpleCustom/Writable&quot;</span>, s.ProcessCustomConfigChanges); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;unable to listen for changes for &#x27;SimpleCustom.Writable&#x27; custom configuration: %s&quot;</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理自定义配置更改</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> ProcessCustomConfigChanges(rawWritableConfig <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">    <span class="comment">//类型断言</span></span><br><span class="line">	updated, ok := rawWritableConfig.(*config.SimpleWritable)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		s.lc.Error(<span class="string">&quot;unable to process custom config updates: Can not cast raw config to type &#x27;SimpleWritable&#x27;&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.lc.Info(<span class="string">&quot;Received configuration updates for &#x27;SimpleCustom.Writable&#x27; section&quot;</span>)</span><br><span class="line"></span><br><span class="line">	previous := s.serviceConfig.SimpleCustom.Writable</span><br><span class="line">	s.serviceConfig.SimpleCustom.Writable = *updated</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否有改动</span></span><br><span class="line">	<span class="keyword">if</span> reflect.DeepEqual(previous, *updated) &#123;</span><br><span class="line">		s.lc.Info(<span class="string">&quot;No changes detected&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查发生了什么变化,以下只是一个示例，并不适合于所有情况</span></span><br><span class="line">	<span class="keyword">if</span> previous.DiscoverSleepDurationSecs != updated.DiscoverSleepDurationSecs &#123;</span><br><span class="line">		s.lc.Infof(<span class="string">&quot;DiscoverSleepDurationSecs changed to: %d&quot;</span>, updated.DiscoverSleepDurationSecs)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HandleReadCommands triggers a protocol Read operation for the specified device.</span></span><br><span class="line"><span class="comment">// 触发指定设备的协议读取操作</span></span><br><span class="line"><span class="comment">// 所需传入的三个参数分别为: 设备名称、设备连接信息、请求的命令内容、命令参数值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> HandleReadCommands(deviceName <span class="type">string</span>, protocols <span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties, reqs []sdkModels.CommandRequest) (res []*sdkModels.CommandValue, err <span class="type">error</span>) &#123;</span><br><span class="line">	s.lc.Debugf(<span class="string">&quot;SimpleDriver.HandleReadCommands: protocols: %v resource: %v attributes: %v&quot;</span>, protocols, reqs[<span class="number">0</span>].DeviceResourceName, reqs[<span class="number">0</span>].Attributes)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(reqs) == <span class="number">1</span> &#123;</span><br><span class="line">		res = <span class="built_in">make</span>([]*sdkModels.CommandValue, <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;SwitchButton&quot;</span> &#123;</span><br><span class="line">            <span class="comment">// 根据valueType创建相关命令</span></span><br><span class="line">			cv, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeBool, s.switchButton)</span><br><span class="line">			res[<span class="number">0</span>] = cv</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;Xrotation&quot;</span> &#123;</span><br><span class="line">			cv, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeInt32, s.xRotation)</span><br><span class="line">			res[<span class="number">0</span>] = cv</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;Yrotation&quot;</span> &#123;</span><br><span class="line">			cv, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeInt32, s.yRotation)</span><br><span class="line">			res[<span class="number">0</span>] = cv</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;Zrotation&quot;</span> &#123;</span><br><span class="line">			cv, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeInt32, s.zRotation)</span><br><span class="line">			res[<span class="number">0</span>] = cv</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;Image&quot;</span> &#123;</span><br><span class="line">			<span class="comment">// 显示开关的二进制图像表示</span></span><br><span class="line">			buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">			<span class="keyword">if</span> s.switchButton == <span class="literal">true</span> &#123;</span><br><span class="line">				err = getImageBytes(s.serviceConfig.SimpleCustom.OnImageLocation, buf)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				err = getImageBytes(s.serviceConfig.SimpleCustom.OffImageLocation, buf)</span><br><span class="line">			&#125;</span><br><span class="line">			cvb, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeBinary, buf.Bytes())</span><br><span class="line">			res[<span class="number">0</span>] = cvb</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;Uint8Array&quot;</span> &#123;</span><br><span class="line">			cv, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeUint8Array, []<span class="type">uint8</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;)</span><br><span class="line">			res[<span class="number">0</span>] = cv</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqs[<span class="number">0</span>].DeviceResourceName == <span class="string">&quot;Counter&quot;</span> &#123;</span><br><span class="line">			cv, _ := sdkModels.NewCommandValue(reqs[<span class="number">0</span>].DeviceResourceName, common.ValueTypeObject, s.counter)</span><br><span class="line">			res[<span class="number">0</span>] = cv</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(reqs) == <span class="number">3</span> &#123;</span><br><span class="line">		res = <span class="built_in">make</span>([]*sdkModels.CommandValue, <span class="number">3</span>)</span><br><span class="line">		<span class="keyword">for</span> i, r := <span class="keyword">range</span> reqs &#123;</span><br><span class="line">			<span class="keyword">var</span> cv *sdkModels.CommandValue</span><br><span class="line">			<span class="keyword">switch</span> r.DeviceResourceName &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&quot;Xrotation&quot;</span>:</span><br><span class="line">				cv, _ = sdkModels.NewCommandValue(r.DeviceResourceName, common.ValueTypeInt32, s.xRotation)</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&quot;Yrotation&quot;</span>:</span><br><span class="line">				cv, _ = sdkModels.NewCommandValue(r.DeviceResourceName, common.ValueTypeInt32, s.yRotation)</span><br><span class="line">			<span class="keyword">case</span> <span class="string">&quot;Zrotation&quot;</span>:</span><br><span class="line">				cv, _ = sdkModels.NewCommandValue(r.DeviceResourceName, common.ValueTypeInt32, s.zRotation)</span><br><span class="line">			&#125;</span><br><span class="line">			res[i] = cv</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传递一个CommandRequest结构的切片,每个切片代表对特定设备资源的操作。由于这些命令是驱动命令,参数为单个命令提供参数</span></span><br><span class="line"><span class="comment">// 所需传入的三个参数分别为: 设备名称、设备连接信息、请求的命令内容</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> HandleWriteCommands(deviceName <span class="type">string</span>, protocols <span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties, reqs []sdkModels.CommandRequest,</span><br><span class="line">	params []*sdkModels.CommandValue) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i, r := <span class="keyword">range</span> reqs &#123;</span><br><span class="line">		s.lc.Debugf(<span class="string">&quot;SimpleDriver.HandleWriteCommands: protocols: %v, resource: %v, parameters: %v, attributes: %v&quot;</span>, protocols, reqs[i].DeviceResourceName, params[i], reqs[i].Attributes)</span><br><span class="line">		<span class="keyword">switch</span> r.DeviceResourceName &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;SwitchButton&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> s.switchButton, err = params[i].BoolValue(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				err := fmt.Errorf(<span class="string">&quot;SimpleDriver.HandleWriteCommands; the data type of parameter should be Boolean, parameter: %s&quot;</span>, params[<span class="number">0</span>].String())</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;Xrotation&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> s.xRotation, err = params[i].Int32Value(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				err := fmt.Errorf(<span class="string">&quot;SimpleDriver.HandleWriteCommands; the data type of parameter should be Int32, parameter: %s&quot;</span>, params[i].String())</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;Yrotation&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> s.yRotation, err = params[i].Int32Value(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				err := fmt.Errorf(<span class="string">&quot;SimpleDriver.HandleWriteCommands; the data type of parameter should be Int32, parameter: %s&quot;</span>, params[i].String())</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;Zrotation&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> s.zRotation, err = params[i].Int32Value(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				err := fmt.Errorf(<span class="string">&quot;SimpleDriver.HandleWriteCommands; the data type of parameter should be Int32, parameter: %s&quot;</span>, params[i].String())</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;Uint8Array&quot;</span>:</span><br><span class="line">			v, err := params[i].Uint8ArrayValue()</span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				s.lc.Debugf(<span class="string">&quot;Uint8 array value from write command: &quot;</span>, v)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;Counter&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> s.counter, err = params[i].ObjectValue(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				err := fmt.Errorf(<span class="string">&quot;SimpleDriver.HandleWriteCommands; the data type of parameter should be Object, parameter: %s&quot;</span>, params[i].String())</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协议特定的设备服务代码将正常关闭，或者如果force参数为“true”，则立即关闭。</span></span><br><span class="line"><span class="comment">// 驱动程序负责关闭任何正在使用的通道，包括用于发送异步读数的通道(如果支持)。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> Stop(force <span class="type">bool</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// Then Logging Client might not be initialized</span></span><br><span class="line">	<span class="keyword">if</span> s.lc != <span class="literal">nil</span> &#123;</span><br><span class="line">		s.lc.Debugf(<span class="string">&quot;SimpleDriver.Stop called: force=%v&quot;</span>, force)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddDevice是一个回调函数，在添加与此设备服务关联的新设备时调用.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> AddDevice(deviceName <span class="type">string</span>, protocols <span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties, adminState models.AdminState) <span class="type">error</span> &#123;</span><br><span class="line">	s.lc.Debugf(<span class="string">&quot;a new Device is added: %s&quot;</span>, deviceName)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UpdateDevice是一个回调函数，在更新与此设备服务关联的设备时调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> UpdateDevice(deviceName <span class="type">string</span>, protocols <span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties, adminState models.AdminState) <span class="type">error</span> &#123;</span><br><span class="line">	s.lc.Debugf(<span class="string">&quot;Device %s is updated&quot;</span>, deviceName)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RemoveDevice是一个回调函数，在删除与此设备服务关联的设备时调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> RemoveDevice(deviceName <span class="type">string</span>, protocols <span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties) <span class="type">error</span> &#123;</span><br><span class="line">	s.lc.Debugf(<span class="string">&quot;Device %s is removed&quot;</span>, deviceName)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于发现特定协议的设备，这是一种异步操作</span></span><br><span class="line"><span class="comment">// 在发现过程中如果找到设备将写入设备操作 </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SimpleDriver)</span></span> Discover() &#123;</span><br><span class="line">	proto := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties)</span><br><span class="line">	proto[<span class="string">&quot;other&quot;</span>] = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;Address&quot;</span>: <span class="string">&quot;simple02&quot;</span>, <span class="string">&quot;Port&quot;</span>: <span class="string">&quot;301&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	device2 := sdkModels.DiscoveredDevice&#123;</span><br><span class="line">		Name:        <span class="string">&quot;Simple-Device02&quot;</span>,</span><br><span class="line">		Protocols:   proto,</span><br><span class="line">		Description: <span class="string">&quot;found by discovery&quot;</span>,</span><br><span class="line">		Labels:      []<span class="type">string</span>&#123;<span class="string">&quot;auto-discovery&quot;</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proto = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]models.ProtocolProperties)</span><br><span class="line">	proto[<span class="string">&quot;other&quot;</span>] = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;Address&quot;</span>: <span class="string">&quot;simple03&quot;</span>, <span class="string">&quot;Port&quot;</span>: <span class="string">&quot;399&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	device3 := sdkModels.DiscoveredDevice&#123;</span><br><span class="line">		Name:        <span class="string">&quot;Simple-Device03&quot;</span>,</span><br><span class="line">		Protocols:   proto,</span><br><span class="line">		Description: <span class="string">&quot;found by discovery&quot;</span>,</span><br><span class="line">		Labels:      []<span class="type">string</span>&#123;<span class="string">&quot;auto-discovery&quot;</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	res := []sdkModels.DiscoveredDevice&#123;device2, device3&#125;</span><br><span class="line"></span><br><span class="line">	time.Sleep(time.Duration(s.serviceConfig.SimpleCustom.Writable.DiscoverSleepDurationSecs) * time.Second)</span><br><span class="line">	s.deviceCh &lt;- res</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>container.go</code> 采用了控制反转的设计模式(IOC)，实现了一个简单的依赖注入容器。为什么要这么做？</p>
<p>　●控制：传统的面向对象程序设计，如果我们需要控制对象，可以直接在对象内部通过new进行创建对象，是程序主动去创建依赖对象；而IOC则是专门有一个容器去创建这些对象，即通过IOC容器来控制对象的创建。所以这边就不是原本的程序控制了对象，而是IOC容器控制了对象；控制了什么？控制了程序的外部资源获取，也就是说现在应用程序需要获取外部资源，那么就需要通过容器来进行操作，显然这降低了程序间的耦合性。</p>
<p>   ●反转：在没有容器的时候，我们需要一个对象的时候，我们必须自己new一个对象，这时候主动权在自己手上，我们可以称之为正转，而现在我们将控制权交给了容器。所以控制反转IOC就是说将创建对象的控制权进行转移，之前创建对象的主动权和创建时机是由自己把控的，而现在这种权力转移到第三方，这边是容器，它就是一个专门用来创建对象的工厂，你要什么对象，它就给你什么对象，有了 IOC容器，此时的依赖关系就变了，原先可能A依赖B，B依赖C，但是现在他们都是依赖IOC容器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> di</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="comment">// 定义一个函数类型</span></span><br><span class="line"><span class="keyword">type</span> Get <span class="function"><span class="keyword">func</span><span class="params">(serviceName <span class="type">string</span>)</span></span> <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个函数类型</span></span><br><span class="line"><span class="keyword">type</span> ServiceConstructor <span class="function"><span class="keyword">func</span><span class="params">(get Get)</span></span> <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServiceConstructorMap maps a service name to a function/closure to create that service.</span></span><br><span class="line"><span class="keyword">type</span> ServiceConstructorMap <span class="keyword">map</span>[<span class="type">string</span>]ServiceConstructor</span><br><span class="line"></span><br><span class="line"><span class="comment">// service is an internal structure used to track a specific service&#x27;s constructor and constructed instance.</span></span><br><span class="line"><span class="keyword">type</span> service <span class="keyword">struct</span> &#123;</span><br><span class="line">	constructor ServiceConstructor</span><br><span class="line">	instance    <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Container is a receiver that maintains a list of services, their constructors, and their constructed instances in a</span></span><br><span class="line"><span class="comment">// thread-safe manner.</span></span><br><span class="line"><span class="keyword">type</span> Container <span class="keyword">struct</span> &#123;</span><br><span class="line">	serviceMap <span class="keyword">map</span>[<span class="type">string</span>]service</span><br><span class="line">	mutex      sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewContainer是一个工厂方法，返回初始化的容器接收器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewContainer</span><span class="params">(serviceConstructors ServiceConstructorMap)</span></span> *Container &#123;</span><br><span class="line">	c := Container&#123;</span><br><span class="line">		serviceMap: <span class="keyword">map</span>[<span class="type">string</span>]service&#123;&#125;,</span><br><span class="line">		mutex:      sync.RWMutex&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> serviceConstructors != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.Update(serviceConstructors)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用提供的ServiceConstructorMap的内容更新serviceMap。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span></span> Update(serviceConstructors ServiceConstructorMap) &#123;</span><br><span class="line">	c.mutex.Lock()</span><br><span class="line">	<span class="keyword">defer</span> c.mutex.Unlock()</span><br><span class="line">	<span class="keyword">for</span> serviceName, constructor := <span class="keyword">range</span> serviceConstructors &#123;</span><br><span class="line">		c.serviceMap[serviceName] = service&#123;</span><br><span class="line">			constructor: constructor,</span><br><span class="line">			instance:    <span class="literal">nil</span>,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get查找请求的serviceName，如果它存在，则返回一个构造的实例。如果请求的服务不存在，则返回nil。</span></span><br><span class="line"><span class="comment">// Get 获取单个实例中的实例构造，实现如果一个实例已经被构造，将被重用并返回给所有后续的get（serviceName）调用。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span></span> get(serviceName <span class="type">string</span>) <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">	service, ok := c.serviceMap[serviceName]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> service.instance == <span class="literal">nil</span> &#123;</span><br><span class="line">		service.instance = service.constructor(c.get)</span><br><span class="line">		c.serviceMap[serviceName] = service</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> service.instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这边实现了container的Get方法，为什么要这么做，主要就是为了用单例模式来保证线程安全。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Container)</span></span> Get(serviceName <span class="type">string</span>) <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">	c.mutex.Lock()</span><br><span class="line">	<span class="keyword">defer</span> c.mutex.Unlock()</span><br><span class="line">	<span class="keyword">return</span> c.get(serviceName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    SDK中提供了这么一个简单的示例用法:</p>
<p>​    首先定义了两种结构体，并且给出了相应的初始化方法，在main函数中，直接讲</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-bootstrap/v2/di&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> foo <span class="keyword">struct</span> &#123;</span><br><span class="line">	FooMessage <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFoo</span><span class="params">(m <span class="type">string</span>)</span></span> *foo &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;foo&#123;</span><br><span class="line">		FooMessage: m,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> bar <span class="keyword">struct</span> &#123;</span><br><span class="line">	BarMessage <span class="type">string</span></span><br><span class="line">	Foo        *foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBar</span><span class="params">(m <span class="type">string</span>, foo *foo)</span></span> *bar &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;bar&#123;</span><br><span class="line">		BarMessage: m,</span><br><span class="line">		Foo:        foo,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	container := di.NewContainer(</span><br><span class="line">		di.ServiceConstructorMap&#123;</span><br><span class="line">            <span class="comment">// 这边传入的函数get没有用到，这边直接返回了一个实例</span></span><br><span class="line">			<span class="string">&quot;foo&quot;</span>: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">				<span class="keyword">return</span> NewFoo(<span class="string">&quot;fooMessage&quot;</span>)</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="string">&quot;bar&quot;</span>: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">				<span class="keyword">return</span> NewBar(<span class="string">&quot;barMessage&quot;</span>, get(<span class="string">&quot;foo&quot;</span>).(*foo))</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;)</span><br><span class="line"></span><br><span class="line">	b := container.Get(<span class="string">&quot;bar&quot;</span>).(*bar)</span><br><span class="line">	fmt.Println(b.BarMessage)</span><br><span class="line">	fmt.Println(b.Foo.FooMessage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lc := container.LoggingClientFrom(dic.Get)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个函数方法也是ServiceConstructor类型的</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoggingClientFrom</span><span class="params">(get di.Get)</span></span> logger.LoggingClient &#123;</span><br><span class="line">	loggingClient, ok := get(LoggingClientInterfaceName).(logger.LoggingClient)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> loggingClient</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>command struct</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CommandProcessor <span class="keyword">struct</span> &#123;</span><br><span class="line">	device        models.Device</span><br><span class="line">	sourceName    <span class="type">string</span></span><br><span class="line">	correlationID <span class="type">string</span></span><br><span class="line">	setParamsMap  <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	attributes    <span class="type">string</span></span><br><span class="line">	dic           *di.Container</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> profileCache <span class="keyword">struct</span> &#123;</span><br><span class="line">	deviceProfileMap  <span class="keyword">map</span>[<span class="type">string</span>]*models.DeviceProfile <span class="comment">// key is DeviceProfile name</span></span><br><span class="line">	deviceResourceMap <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]models.DeviceResource</span><br><span class="line">	deviceCommandMap  <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]models.DeviceCommand</span><br><span class="line">	mutex             sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DeviceResource <span class="keyword">struct</span> &#123;</span><br><span class="line">	Description <span class="type">string</span></span><br><span class="line">	Name        <span class="type">string</span></span><br><span class="line">	IsHidden    <span class="type">bool</span></span><br><span class="line">	Tag         <span class="type">string</span></span><br><span class="line">	Properties  ResourceProperties</span><br><span class="line">	Attributes  <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DeviceCommand <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name               <span class="type">string</span></span><br><span class="line">	IsHidden           <span class="type">bool</span></span><br><span class="line">	ReadWrite          <span class="type">string</span></span><br><span class="line">	ResourceOperations []ResourceOperation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ResourceOperation <span class="keyword">struct</span> &#123;</span><br><span class="line">	DeviceResource <span class="type">string</span></span><br><span class="line">	DefaultValue   <span class="type">string</span></span><br><span class="line">	Mappings       <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CommandRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// DeviceResourceName is the name of Device Resource for this command</span></span><br><span class="line">	DeviceResourceName <span class="type">string</span></span><br><span class="line">	<span class="comment">// Attributes is a key/value map to represent the attributes of the Device Resource</span></span><br><span class="line">	Attributes <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// Type is the data type of the Device Resource</span></span><br><span class="line">	Type <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CommandValue is the struct to represent the reading value of a Get command coming</span></span><br><span class="line"><span class="comment">// from ProtocolDrivers or the parameter of a Put command sending to ProtocolDrivers.</span></span><br><span class="line"><span class="keyword">type</span> CommandValue <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// DeviceResourceName is the name of Device Resource for this command</span></span><br><span class="line">	DeviceResourceName <span class="type">string</span></span><br><span class="line">	<span class="comment">// Type indicates what type of value was returned from the ProtocolDriver instance in</span></span><br><span class="line">	<span class="comment">// response to HandleCommand being called to handle a single ResourceOperation.</span></span><br><span class="line">	Type <span class="type">string</span></span><br><span class="line">	<span class="comment">// Value holds value returned by a ProtocolDriver instance.</span></span><br><span class="line">	<span class="comment">// The value can be converted to its native type by referring to ValueType.</span></span><br><span class="line">	Value <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// Origin is an int64 value which indicates the time the reading</span></span><br><span class="line">	<span class="comment">// contained in the CommandValue was read by the ProtocolDriver</span></span><br><span class="line">	<span class="comment">// instance.</span></span><br><span class="line">	Origin <span class="type">int64</span></span><br><span class="line">	<span class="comment">// Tags allows device service to add custom information to the Event in order to</span></span><br><span class="line">	<span class="comment">// help identify its origin or otherwise label it before it is send to north side.</span></span><br><span class="line">	Tags <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>command.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// -*- Mode: Go; indent-tabs-mode: t -*-</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Copyright (C) 2020-2021 IOTech Ltd</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> application</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line">	bootstrapContainer <span class="string">&quot;github.com/edgexfoundry/go-mod-bootstrap/v2/bootstrap/container&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-bootstrap/v2/di&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/common&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/dtos&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/errors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/go-mod-core-contracts/v2/models&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/internal/cache&quot;</span></span><br><span class="line">	sdkCommon <span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/internal/common&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/internal/container&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/internal/transformer&quot;</span></span><br><span class="line">	sdkModels <span class="string">&quot;github.com/edgexfoundry/device-sdk-go/v2/pkg/models&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CommandProcessor <span class="keyword">struct</span> &#123;</span><br><span class="line">	device        models.Device</span><br><span class="line">	sourceName    <span class="type">string</span></span><br><span class="line">	correlationID <span class="type">string</span></span><br><span class="line">	setParamsMap  <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	attributes    <span class="type">string</span></span><br><span class="line">	dic           *di.Container</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCommandProcessor</span><span class="params">(device models.Device, sourceName <span class="type">string</span>, correlationID <span class="type">string</span>, setParamsMap <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, attributes <span class="type">string</span>, dic *di.Container)</span></span> *CommandProcessor &#123;</span><br><span class="line">	<span class="keyword">if</span> setParamsMap == <span class="literal">nil</span> &#123;</span><br><span class="line">		setParamsMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;CommandProcessor&#123;</span><br><span class="line">		device:        device,</span><br><span class="line">		sourceName:    sourceName,</span><br><span class="line">		correlationID: correlationID,</span><br><span class="line">		setParamsMap:  setParamsMap,</span><br><span class="line">		attributes:    attributes,</span><br><span class="line">		dic:           dic,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CommandHandler 命令处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CommandHandler</span><span class="params">(isRead <span class="type">bool</span>, sendEvent <span class="type">bool</span>, correlationID <span class="type">string</span>, vars <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, setParamsMap <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, attributes <span class="type">string</span>, dic *di.Container)</span></span> (res *dtos.Event, err errors.EdgeX) &#123;</span><br><span class="line">	<span class="comment">// check device service AdminState</span></span><br><span class="line">	<span class="comment">// 检查设备服务管理状态</span></span><br><span class="line">	ds := container.DeviceServiceFrom(dic.Get)</span><br><span class="line">	<span class="comment">// 锁定状态</span></span><br><span class="line">	<span class="keyword">if</span> ds.AdminState == models.Locked &#123;</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServiceLocked, <span class="string">&quot;service locked&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check provided device exists</span></span><br><span class="line">	<span class="comment">// 检查设备是否存在</span></span><br><span class="line">	deviceKey := vars[common.Name]</span><br><span class="line">	device, ok := cache.Devices().ForName(deviceKey)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindEntityDoesNotExist, fmt.Sprintf(<span class="string">&quot;device %s not found&quot;</span>, deviceKey), <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check device&#x27;s AdminState</span></span><br><span class="line">	<span class="comment">// 检查设备管理状态</span></span><br><span class="line">	<span class="keyword">if</span> device.AdminState == models.Locked &#123;</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServiceLocked, fmt.Sprintf(<span class="string">&quot;device %s locked&quot;</span>, device.Name), <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check device&#x27;s OperatingState</span></span><br><span class="line">	<span class="comment">// 检查设备操作状态</span></span><br><span class="line">	<span class="keyword">if</span> device.OperatingState == models.Down &#123;</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServiceLocked, fmt.Sprintf(<span class="string">&quot;device %s OperatingState is DOWN&quot;</span>, device.Name), <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// the device service will perform some operations(e.g. update LastConnected timestamp,</span></span><br><span class="line">	<span class="comment">// push returning event to core-data) after a device is successfully interacted with if</span></span><br><span class="line">	<span class="comment">// it has been configured to do so, and those operation apply to every protocol and</span></span><br><span class="line">	<span class="comment">// need to be finished in the end of application layer before returning to protocol layer.</span></span><br><span class="line">	<span class="comment">// 设备服务将在与设备成功交互后执行一些操作</span></span><br><span class="line">	<span class="comment">// 例如更新LastConnected timestamp(最后一次连接时间戳)、将返回事件推送到核心数据</span></span><br><span class="line">	<span class="comment">// 如果设备已被配置为执行这些操作，则这些操作将应用于每个协议，并且需要在应用层末尾完成，然后再返回到协议层。</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		config := container.ConfigurationFrom(dic.Get)</span><br><span class="line">		<span class="comment">// 更新最后一次连接时间戳</span></span><br><span class="line">		<span class="keyword">if</span> config.Device.UpdateLastConnected &#123;</span><br><span class="line">			<span class="keyword">go</span> sdkCommon.UpdateLastConnected(device.Name, bootstrapContainer.LoggingClientFrom(dic.Get), bootstrapContainer.MetadataDeviceClientFrom(dic.Get))</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 将返回时间推送到核心数据</span></span><br><span class="line">		<span class="keyword">if</span> res != <span class="literal">nil</span> &amp;&amp; sendEvent &#123;</span><br><span class="line">			<span class="keyword">go</span> sdkCommon.SendEvent(res, correlationID, dic)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	cmd := vars[common.Command]</span><br><span class="line">	<span class="comment">// 创建命令处理器对象</span></span><br><span class="line">	helper := NewCommandProcessor(device, cmd, correlationID, setParamsMap, attributes, dic)</span><br><span class="line">	<span class="comment">// 判断命令是否存在</span></span><br><span class="line">	_, cmdExist := cache.Profiles().DeviceCommand(device.ProfileName, cmd)</span><br><span class="line">	<span class="keyword">if</span> cmdExist &#123;</span><br><span class="line">		<span class="comment">// 如果只读,返回读设备命令</span></span><br><span class="line">		<span class="keyword">if</span> isRead &#123;</span><br><span class="line">			<span class="keyword">return</span> helper.ReadDeviceCommand()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> res, helper.WriteDeviceCommand()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> isRead &#123;</span><br><span class="line">			<span class="keyword">return</span> helper.ReadDeviceResource()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> res, helper.WriteDeviceResource()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CommandProcessor)</span></span> ReadDeviceResource() (res *dtos.Event, e errors.EdgeX) &#123;</span><br><span class="line">	dr, ok := cache.Profiles().DeviceResource(c.device.ProfileName, c.sourceName)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s not found&quot;</span>, c.sourceName)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindEntityDoesNotExist, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check deviceResource is not write-only</span></span><br><span class="line">	<span class="keyword">if</span> dr.Properties.ReadWrite == common.ReadWrite_W &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s is marked as write-only&quot;</span>, dr.Name)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindNotAllowed, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lc := bootstrapContainer.LoggingClientFrom(c.dic.Get)</span><br><span class="line">	lc.Debugf(<span class="string">&quot;Application - readDeviceResource: reading deviceResource: %s; %s: %s&quot;</span>, dr.Name, common.CorrelationHeader, c.correlationID)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> req sdkModels.CommandRequest</span><br><span class="line">	<span class="keyword">var</span> reqs []sdkModels.CommandRequest</span><br><span class="line"></span><br><span class="line">	<span class="comment">// prepare CommandRequest</span></span><br><span class="line">	req.DeviceResourceName = dr.Name</span><br><span class="line">	req.Attributes = dr.Attributes</span><br><span class="line">	<span class="keyword">if</span> c.attributes != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(req.Attributes) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">			req.Attributes = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		req.Attributes[sdkCommon.URLRawQuery] = c.attributes</span><br><span class="line">	&#125;</span><br><span class="line">	req.Type = dr.Properties.ValueType</span><br><span class="line">	reqs = <span class="built_in">append</span>(reqs, req)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute protocol-specific read operation</span></span><br><span class="line">	driver := container.ProtocolDriverFrom(c.dic.Get)</span><br><span class="line">	results, err := driver.HandleReadCommands(c.device.Name, c.device.Protocols, reqs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;error reading DeviceResourece %s for %s&quot;</span>, dr.Name, c.device.Name)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// convert CommandValue to Event</span></span><br><span class="line">	res, e = transformer.CommandValuesToEventDTO(results, c.device.Name, dr.Name, c.dic)</span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;failed to convert CommandValue to Event&quot;</span>, e)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CommandProcessor)</span></span> ReadDeviceCommand() (res *dtos.Event, e errors.EdgeX) &#123;</span><br><span class="line">	<span class="comment">// 通过给定的profileName和sourceName返回设备命令实例并且检查该设备命令是否存在 DeviceCommand见profiles.go</span></span><br><span class="line">	dc, ok := cache.Profiles().DeviceCommand(c.device.ProfileName, c.sourceName)</span><br><span class="line">	<span class="comment">// 不存在</span></span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceCommand %s not found&quot;</span>, c.sourceName)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindEntityDoesNotExist, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check deviceCommand is not write-only</span></span><br><span class="line">	<span class="comment">// 检查设备命令是否为只写</span></span><br><span class="line">	<span class="keyword">if</span> dc.ReadWrite == common.ReadWrite_W &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceCommand %s is marked as write-only&quot;</span>, dc.Name)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindNotAllowed, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check ResourceOperation count does not exceed MaxCmdOps defined in configuration</span></span><br><span class="line">	<span class="comment">// 检查资源操作计数是否超过配置中定义的MaxCmdOps,如果超过,返回错误</span></span><br><span class="line">	configuration := container.ConfigurationFrom(c.dic.Get)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(dc.ResourceOperations) &gt; configuration.Device.MaxCmdOps &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;GET command %s exceed device %s MaxCmdOps (%d)&quot;</span>, dc.Name, c.device.Name, configuration.Device.MaxCmdOps)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServerError, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lc := bootstrapContainer.LoggingClientFrom(c.dic.Get)</span><br><span class="line">	lc.Debugf(<span class="string">&quot;Application - readCmd: reading cmd: %s; %s: %s&quot;</span>, dc.Name, common.CorrelationHeader, c.correlationID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// prepare CommandRequests</span></span><br><span class="line">	<span class="comment">// 准备命令请求</span></span><br><span class="line">	reqs := <span class="built_in">make</span>([]sdkModels.CommandRequest, <span class="built_in">len</span>(dc.ResourceOperations))</span><br><span class="line">	<span class="comment">// 遍历资源操作切片</span></span><br><span class="line">	<span class="keyword">for</span> i, op := <span class="keyword">range</span> dc.ResourceOperations &#123;</span><br><span class="line">		<span class="comment">// 设备资源名</span></span><br><span class="line">		drName := op.DeviceResource</span><br><span class="line">		<span class="comment">// check the deviceResource in ResourceOperation actually exist</span></span><br><span class="line">		<span class="comment">// 检查该设备资源在资源操作map中是否真实存在(也就是判断这个设备资源是否可以执行给定操作)，返回设备资源实例</span></span><br><span class="line">		dr, ok := cache.Profiles().DeviceResource(c.device.ProfileName, drName)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s in GET commnd %s for %s not defined&quot;</span>, drName, dc.Name, c.device.Name)</span><br><span class="line">			<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServerError, errMsg, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 保存设备请求</span></span><br><span class="line">		reqs[i].DeviceResourceName = dr.Name</span><br><span class="line">		reqs[i].Attributes = dr.Attributes</span><br><span class="line">		<span class="keyword">if</span> c.attributes != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(reqs[i].Attributes) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">				reqs[i].Attributes = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">			reqs[i].Attributes[sdkCommon.URLRawQuery] = c.attributes</span><br><span class="line">		&#125;</span><br><span class="line">		reqs[i].Type = dr.Properties.ValueType</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute protocol-specific read operation</span></span><br><span class="line">	<span class="comment">// 执行特定协议的读取操作</span></span><br><span class="line">	<span class="comment">// 获取特定协议的驱动实例</span></span><br><span class="line">	driver := container.ProtocolDriverFrom(c.dic.Get)</span><br><span class="line">	<span class="comment">// 处理读命令请求，返回结果</span></span><br><span class="line">	<span class="comment">// HandleReadCommands在 simpledriver.go 中实现</span></span><br><span class="line">	results, err := driver.HandleReadCommands(c.device.Name, c.device.Protocols, reqs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;error reading DeviceCommand %s for %s&quot;</span>, dc.Name, c.device.Name)</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// convert CommandValue to Event</span></span><br><span class="line">	<span class="comment">// 将命令数据转为事件</span></span><br><span class="line">	res, e = transformer.CommandValuesToEventDTO(results, c.device.Name, dc.Name, c.dic)</span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> res, errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;failed to transform CommandValue to Event&quot;</span>, e)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WriteDeviceResource 写设备资源</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CommandProcessor)</span></span> WriteDeviceResource() (e errors.EdgeX) &#123;</span><br><span class="line">	<span class="comment">// 通过给定的profileName和sourceName返回设备资源实例并且检查该设备命令是否存在 DeviceCommand见profiles.go</span></span><br><span class="line">	dr, ok := cache.Profiles().DeviceResource(c.device.ProfileName, c.sourceName)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s not found&quot;</span>, c.sourceName)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindEntityDoesNotExist, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check deviceResource is not read-only</span></span><br><span class="line">	<span class="comment">// 检查设备命令是否为只读</span></span><br><span class="line">	<span class="keyword">if</span> dr.Properties.ReadWrite == common.ReadWrite_R &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s is marked as read-only&quot;</span>, dr.Name)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindNotAllowed, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lc := bootstrapContainer.LoggingClientFrom(c.dic.Get)</span><br><span class="line">	lc.Debugf(<span class="string">&quot;Application - writeDeviceResource: writing deviceResource: %s; %s: %s&quot;</span>, dr.Name, common.CorrelationHeader, c.correlationID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check request body contains provided deviceResource</span></span><br><span class="line">	<span class="comment">// 检查请求体包含给定的设备资源</span></span><br><span class="line">	v, ok := c.setParamsMap[dr.Name]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">if</span> dr.Properties.DefaultValue != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			v = dr.Properties.DefaultValue</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s not found in request body and no default value defined&quot;</span>, dr.Name)</span><br><span class="line">			<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, errMsg, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create CommandValue</span></span><br><span class="line">	<span class="comment">// 创建命令数据结构</span></span><br><span class="line">	cv, e := createCommandValueFromDeviceResource(dr, v)</span><br><span class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;failed to create CommandValue&quot;</span>, e)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// prepare CommandRequest</span></span><br><span class="line">	<span class="comment">// 准备命令请求</span></span><br><span class="line">	reqs := <span class="built_in">make</span>([]sdkModels.CommandRequest, <span class="number">1</span>)</span><br><span class="line">	reqs[<span class="number">0</span>].DeviceResourceName = cv.DeviceResourceName</span><br><span class="line">	reqs[<span class="number">0</span>].Attributes = dr.Attributes</span><br><span class="line">	<span class="comment">// 如果命令处理实例的参数不为空，则存入reqs[0].Attributes[sdkCommon.URLRawQuery]</span></span><br><span class="line">	<span class="keyword">if</span> c.attributes != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(reqs[<span class="number">0</span>].Attributes) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">			reqs[<span class="number">0</span>].Attributes = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">		reqs[<span class="number">0</span>].Attributes[sdkCommon.URLRawQuery] = c.attributes</span><br><span class="line">	&#125;</span><br><span class="line">	reqs[<span class="number">0</span>].Type = cv.Type</span><br><span class="line"></span><br><span class="line">	<span class="comment">// transform write value</span></span><br><span class="line">	<span class="comment">// 执行写入操作</span></span><br><span class="line">	configuration := container.ConfigurationFrom(c.dic.Get)</span><br><span class="line">	<span class="keyword">if</span> configuration.Device.DataTransform &#123;</span><br><span class="line">		e = transformer.TransformWriteParameter(cv, dr.Properties)</span><br><span class="line">		<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindContractInvalid, <span class="string">&quot;failed to transform set parameter&quot;</span>, e)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute protocol-specific write operation</span></span><br><span class="line">	driver := container.ProtocolDriverFrom(c.dic.Get)</span><br><span class="line">	err := driver.HandleWriteCommands(c.device.Name, c.device.Protocols, reqs, []*sdkModels.CommandValue&#123;cv&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;error writing DeviceResourece %s for %s&quot;</span>, dr.Name, c.device.Name)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *CommandProcessor)</span></span> WriteDeviceCommand() errors.EdgeX &#123;</span><br><span class="line">	dc, ok := cache.Profiles().DeviceCommand(c.device.ProfileName, c.sourceName)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceCommand %s not found&quot;</span>, c.sourceName)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindEntityDoesNotExist, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check deviceCommand is not read-only</span></span><br><span class="line">	<span class="keyword">if</span> dc.ReadWrite == common.ReadWrite_R &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;deviceCommand %s is marked as read-only&quot;</span>, dc.Name)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindNotAllowed, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// check ResourceOperation count does not exceed MaxCmdOps defined in configuration</span></span><br><span class="line">	configuration := container.ConfigurationFrom(c.dic.Get)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(dc.ResourceOperations) &gt; configuration.Device.MaxCmdOps &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;SET command %s exceed device %s MaxCmdOps (%d)&quot;</span>, dc.Name, c.device.Name, configuration.Device.MaxCmdOps)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, errMsg, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lc := bootstrapContainer.LoggingClientFrom(c.dic.Get)</span><br><span class="line">	lc.Debugf(<span class="string">&quot;Application - writeCmd: writing command: %s; %s: %s&quot;</span>, dc.Name, common.CorrelationHeader, c.correlationID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create CommandValues</span></span><br><span class="line">	cvs := <span class="built_in">make</span>([]*sdkModels.CommandValue, <span class="number">0</span>, <span class="built_in">len</span>(c.setParamsMap))</span><br><span class="line">	<span class="keyword">for</span> _, ro := <span class="keyword">range</span> dc.ResourceOperations &#123;</span><br><span class="line">		drName := ro.DeviceResource</span><br><span class="line">		<span class="comment">// check the deviceResource in ResourceOperation actually exist</span></span><br><span class="line">		dr, ok := cache.Profiles().DeviceResource(c.device.ProfileName, drName)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s in SET commnd %s for %s not defined&quot;</span>, drName, dc.Name, c.device.Name)</span><br><span class="line">			<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, errMsg, <span class="literal">nil</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// check request body contains the deviceResource</span></span><br><span class="line">		value, ok := c.setParamsMap[ro.DeviceResource]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">if</span> ro.DefaultValue != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">				value = ro.DefaultValue</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> dr.Properties.DefaultValue != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">				value = dr.Properties.DefaultValue</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				errMsg := fmt.Sprintf(<span class="string">&quot;deviceResource %s not found in request body and no default value defined&quot;</span>, dr.Name)</span><br><span class="line">				<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, errMsg, <span class="literal">nil</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ResourceOperation mapping, notice that the order is opposite to get command mapping</span></span><br><span class="line">		<span class="comment">// i.e. the mapping value is actually the key for set command.</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ro.Mappings) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> k, v := <span class="keyword">range</span> ro.Mappings &#123;</span><br><span class="line">				<span class="keyword">if</span> v == value &#123;</span><br><span class="line">					value = k</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// create CommandValue</span></span><br><span class="line">		cv, err := createCommandValueFromDeviceResource(dr, value)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			cvs = <span class="built_in">append</span>(cvs, cv)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;failed to create CommandValue&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// prepare CommandRequests</span></span><br><span class="line">	reqs := <span class="built_in">make</span>([]sdkModels.CommandRequest, <span class="built_in">len</span>(cvs))</span><br><span class="line">	<span class="keyword">for</span> i, cv := <span class="keyword">range</span> cvs &#123;</span><br><span class="line">		dr, _ := cache.Profiles().DeviceResource(c.device.ProfileName, cv.DeviceResourceName)</span><br><span class="line"></span><br><span class="line">		reqs[i].DeviceResourceName = cv.DeviceResourceName</span><br><span class="line">		reqs[i].Attributes = dr.Attributes</span><br><span class="line">		<span class="keyword">if</span> c.attributes != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(reqs[i].Attributes) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">				reqs[i].Attributes = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">			reqs[i].Attributes[sdkCommon.URLRawQuery] = c.attributes</span><br><span class="line">		&#125;</span><br><span class="line">		reqs[i].Type = cv.Type</span><br><span class="line"></span><br><span class="line">		<span class="comment">// transform write value</span></span><br><span class="line">		<span class="keyword">if</span> configuration.Device.DataTransform &#123;</span><br><span class="line">			err := transformer.TransformWriteParameter(cv, dr.Properties)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindContractInvalid, <span class="string">&quot;failed to transform set parameter&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute protocol-specific write operation</span></span><br><span class="line">	driver := container.ProtocolDriverFrom(c.dic.Get)</span><br><span class="line">	err := driver.HandleWriteCommands(c.device.Name, c.device.Protocols, reqs, cvs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		errMsg := fmt.Sprintf(<span class="string">&quot;error writing DeviceCommand %s for %s&quot;</span>, dc.Name, c.device.Name)</span><br><span class="line">		<span class="keyword">return</span> errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createCommandValueFromDeviceResource</span><span class="params">(dr models.DeviceResource, value <span class="keyword">interface</span>&#123;&#125;)</span></span> (*sdkModels.CommandValue, errors.EdgeX) &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	<span class="keyword">var</span> result *sdkModels.CommandValue</span><br><span class="line"></span><br><span class="line">	v := fmt.Sprint(value)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据设备资源属性值的类型创建命令参数结构</span></span><br><span class="line">	<span class="keyword">switch</span> dr.Properties.ValueType &#123;</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeString:</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeString, v)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeBool:</span><br><span class="line">		<span class="keyword">var</span> value <span class="type">bool</span></span><br><span class="line">		<span class="comment">// 将value转化为bool类型</span></span><br><span class="line">		value, err = strconv.ParseBool(v)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeBool, value)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeBoolArray:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">bool</span></span><br><span class="line">		<span class="comment">// 解析json数据存入布尔型arr切片</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeBoolArray, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint8:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">uint64</span></span><br><span class="line">		n, err = strconv.ParseUint(v, <span class="number">10</span>, <span class="number">8</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint8, <span class="type">uint8</span>(n))</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint8Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">uint8</span></span><br><span class="line">		strArr := strings.Split(strings.Trim(v, <span class="string">&quot;[]&quot;</span>), <span class="string">&quot;,&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> _, u := <span class="keyword">range</span> strArr &#123;</span><br><span class="line">			n, err := strconv.ParseUint(strings.Trim(u, <span class="string">&quot; &quot;</span>), <span class="number">10</span>, <span class="number">8</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">				<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">			&#125;</span><br><span class="line">			arr = <span class="built_in">append</span>(arr, <span class="type">uint8</span>(n))</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint8Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint16:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">uint64</span></span><br><span class="line">		n, err = strconv.ParseUint(v, <span class="number">10</span>, <span class="number">16</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint16, <span class="type">uint16</span>(n))</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint16Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">uint16</span></span><br><span class="line">		strArr := strings.Split(strings.Trim(v, <span class="string">&quot;[]&quot;</span>), <span class="string">&quot;,&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> _, u := <span class="keyword">range</span> strArr &#123;</span><br><span class="line">			n, err := strconv.ParseUint(strings.Trim(u, <span class="string">&quot; &quot;</span>), <span class="number">10</span>, <span class="number">16</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">				<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">			&#125;</span><br><span class="line">			arr = <span class="built_in">append</span>(arr, <span class="type">uint16</span>(n))</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint16Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint32:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">uint64</span></span><br><span class="line">		n, err = strconv.ParseUint(v, <span class="number">10</span>, <span class="number">32</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint32, <span class="type">uint32</span>(n))</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint32Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">uint32</span></span><br><span class="line">		strArr := strings.Split(strings.Trim(v, <span class="string">&quot;[]&quot;</span>), <span class="string">&quot;,&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> _, u := <span class="keyword">range</span> strArr &#123;</span><br><span class="line">			n, err := strconv.ParseUint(strings.Trim(u, <span class="string">&quot; &quot;</span>), <span class="number">10</span>, <span class="number">32</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">				<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">			&#125;</span><br><span class="line">			arr = <span class="built_in">append</span>(arr, <span class="type">uint32</span>(n))</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint32Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint64:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">uint64</span></span><br><span class="line">		n, err = strconv.ParseUint(v, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint64, n)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeUint64Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">uint64</span></span><br><span class="line">		strArr := strings.Split(strings.Trim(v, <span class="string">&quot;[]&quot;</span>), <span class="string">&quot;,&quot;</span>)</span><br><span class="line">		<span class="keyword">for</span> _, u := <span class="keyword">range</span> strArr &#123;</span><br><span class="line">			n, err := strconv.ParseUint(strings.Trim(u, <span class="string">&quot; &quot;</span>), <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">				<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">			&#125;</span><br><span class="line">			arr = <span class="built_in">append</span>(arr, n)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeUint64Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt8:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">int64</span></span><br><span class="line">		n, err = strconv.ParseInt(v, <span class="number">10</span>, <span class="number">8</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt8, <span class="type">int8</span>(n))</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt8Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">int8</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt8Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt16:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">int64</span></span><br><span class="line">		n, err = strconv.ParseInt(v, <span class="number">10</span>, <span class="number">16</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt16, <span class="type">int16</span>(n))</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt16Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">int16</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt16Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt32:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">int64</span></span><br><span class="line">		n, err = strconv.ParseInt(v, <span class="number">10</span>, <span class="number">32</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt32, <span class="type">int32</span>(n))</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt32Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">int32</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt32Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt64:</span><br><span class="line">		<span class="keyword">var</span> n <span class="type">int64</span></span><br><span class="line">		n, err = strconv.ParseInt(v, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt64, n)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeInt64Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">int64</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeInt64Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeFloat32:</span><br><span class="line">		<span class="keyword">var</span> val <span class="type">float64</span></span><br><span class="line">		val, err = strconv.ParseFloat(v, <span class="number">32</span>)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeFloat32, <span class="type">float32</span>(val))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> numError, ok := err.(*strconv.NumError); ok &#123;</span><br><span class="line">			<span class="keyword">if</span> numError.Err == strconv.ErrRange &#123;</span><br><span class="line">				err = errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;NumError&quot;</span>, err)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> decodedToBytes []<span class="type">byte</span></span><br><span class="line">		decodedToBytes, err = base64.StdEncoding.DecodeString(v)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> val <span class="type">float32</span></span><br><span class="line">			val, err = float32FromBytes(decodedToBytes)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> math.IsNaN(<span class="type">float64</span>(val)) &#123;</span><br><span class="line">				err = fmt.Errorf(<span class="string">&quot;fail to parse %v to float32, unexpected result %v&quot;</span>, v, val)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeFloat32, val)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeFloat32Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">float32</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeFloat32Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeFloat64:</span><br><span class="line">		<span class="keyword">var</span> val <span class="type">float64</span></span><br><span class="line">		val, err = strconv.ParseFloat(v, <span class="number">64</span>)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeFloat64, val)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> numError, ok := err.(*strconv.NumError); ok &#123;</span><br><span class="line">			<span class="keyword">if</span> numError.Err == strconv.ErrRange &#123;</span><br><span class="line">				err = errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;NumError&quot;</span>, err)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> decodedToBytes []<span class="type">byte</span></span><br><span class="line">		decodedToBytes, err = base64.StdEncoding.DecodeString(v)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			val, err = float64FromBytes(decodedToBytes)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> math.IsNaN(val) &#123;</span><br><span class="line">				err = fmt.Errorf(<span class="string">&quot;fail to parse %v to float64, unexpected result %v&quot;</span>, v, val)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeFloat64, val)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeFloat64Array:</span><br><span class="line">		<span class="keyword">var</span> arr []<span class="type">float64</span></span><br><span class="line">		err = json.Unmarshal([]<span class="type">byte</span>(v), &amp;arr)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			errMsg := fmt.Sprintf(<span class="string">&quot;failed to convert set parameter %s to ValueType %s&quot;</span>, v, dr.Properties.ValueType)</span><br><span class="line">			<span class="keyword">return</span> result, errors.NewCommonEdgeX(errors.KindServerError, errMsg, err)</span><br><span class="line">		&#125;</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeFloat64Array, arr)</span><br><span class="line">	<span class="keyword">case</span> common.ValueTypeObject:</span><br><span class="line">		result, err = sdkModels.NewCommandValue(dr.Name, common.ValueTypeObject, value)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		err = errors.NewCommonEdgeX(errors.KindServerError, <span class="string">&quot;unrecognized value type&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.NewCommonEdgeXWrapper(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">float32FromBytes</span><span class="params">(numericValue []<span class="type">byte</span>)</span></span> (res <span class="type">float32</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	reader := bytes.NewReader(numericValue)</span><br><span class="line">	err = binary.Read(reader, binary.BigEndian, &amp;res)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">float64FromBytes</span><span class="params">(numericValue []<span class="type">byte</span>)</span></span> (res <span class="type">float64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	reader := bytes.NewReader(numericValue)</span><br><span class="line">	err = binary.Read(reader, binary.BigEndian, &amp;res)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h3 id="device-sdk-go流程梳理"><a href="#device-sdk-go流程梳理" class="headerlink" title="device-sdk-go流程梳理"></a>device-sdk-go流程梳理</h3><h4 id="1-生成初始Driver，调用Bootstrap-传入服务名称，设备版本，以及初始Driver"><a href="#1-生成初始Driver，调用Bootstrap-传入服务名称，设备版本，以及初始Driver" class="headerlink" title="1.生成初始Driver，调用Bootstrap:传入服务名称，设备版本，以及初始Driver"></a>1.生成初始Driver，调用Bootstrap:传入服务名称，设备版本，以及初始Driver</h4><h4 id="2-进入Bootstrap-生成当前context以及cancel，调用Main，Main传入的参数有-服务名称，服务版本，初始驱动，context-cancel，以及Router"><a href="#2-进入Bootstrap-生成当前context以及cancel，调用Main，Main传入的参数有-服务名称，服务版本，初始驱动，context-cancel，以及Router" class="headerlink" title="2.进入Bootstrap:生成当前context以及cancel，调用Main，Main传入的参数有:服务名称，服务版本，初始驱动，context,cancel，以及Router"></a>2.进入Bootstrap:生成当前context以及cancel，调用Main，Main传入的参数有:服务名称，服务版本，初始驱动，context,cancel，以及Router</h4><h4 id="3-进入Main流程："><a href="#3-进入Main流程：" class="headerlink" title="3.进入Main流程："></a>3.进入Main流程：</h4><h5 id="1）生成定时器（根据服务名称获取系统配置的超时时间以及interval的配置，如果不存在则使用默认值）"><a href="#1）生成定时器（根据服务名称获取系统配置的超时时间以及interval的配置，如果不存在则使用默认值）" class="headerlink" title="1）生成定时器（根据服务名称获取系统配置的超时时间以及interval的配置，如果不存在则使用默认值）"></a>1）生成定时器（根据服务名称获取系统配置的超时时间以及interval的配置，如果不存在则使用默认值）</h5><h5 id="2）解析命令行参数"><a href="#2）解析命令行参数" class="headerlink" title="2）解析命令行参数"></a>2）解析命令行参数</h5><h5 id="3）设置服务名-服务名为name-os-Getenv-“EDGEX-INSTANCE-NAME”"><a href="#3）设置服务名-服务名为name-os-Getenv-“EDGEX-INSTANCE-NAME”" class="headerlink" title="3）设置服务名 服务名为name+os.Getenv(“EDGEX_INSTANCE_NAME”)"></a>3）设置服务名 服务名为name+os.Getenv(“EDGEX_INSTANCE_NAME”)</h5><h5 id="4）生成初始设备服务实例-空"><a href="#4）生成初始设备服务实例-空" class="headerlink" title="4）生成初始设备服务实例(空)"></a>4）生成初始设备服务实例(空)</h5><h5 id="5）初始化设备服务实例-用户必须提供服务名，其他内容由sdk内部提供"><a href="#5）初始化设备服务实例-用户必须提供服务名，其他内容由sdk内部提供" class="headerlink" title="5）初始化设备服务实例(用户必须提供服务名，其他内容由sdk内部提供)"></a>5）初始化设备服务实例(用户必须提供服务名，其他内容由sdk内部提供)</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s.ServiceName = serviceName <span class="comment">//由用户指定</span></span><br><span class="line">sdkCommon.ServiceVersion = serviceVersion  <span class="comment">//由makefile指定</span></span><br><span class="line">s.driver = driver <span class="comment">//此处断言成sdk内部提供的ProtocolDriver接口 只需要用户实现接口中的所有方法即可断言成功</span></span><br><span class="line">s.discovery = discovery <span class="comment">//可以没有</span></span><br><span class="line">s.deviceService = &amp;models.DeviceService&#123;&#125;  <span class="comment">//初始化models.DeviceService （注意对应s.deviceService）</span></span><br><span class="line">s.config = &amp;config.ConfigurationStruct&#123;&#125;   <span class="comment">//初始化ConfigurationStruct</span></span><br></pre></td></tr></table></figure>

<h5 id="6）保存命令行参数"><a href="#6）保存命令行参数" class="headerlink" title="6）保存命令行参数"></a>6）保存命令行参数</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ds.flags=sdkFlags</span><br></pre></td></tr></table></figure>

<h5 id="7）初始化容器（关键就是存入ServiceConstructorMap）"><a href="#7）初始化容器（关键就是存入ServiceConstructorMap）" class="headerlink" title="7）初始化容器（关键就是存入ServiceConstructorMap）"></a>7）初始化容器（关键就是存入ServiceConstructorMap）</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注意：比如container.ConfigurationName</span></span><br><span class="line"><span class="comment">//var ConfigurationName = di.TypeInstanceToName(config.ConfigurationStruct&#123;&#125;)</span></span><br><span class="line"><span class="comment">//其name是PkgPath.interfaceName or PkgPath.non-interfaceName组成</span></span><br><span class="line"><span class="comment">//当第一次调用比如</span></span><br><span class="line"><span class="comment">//ct:=container.TConfigurationFrom(dic.Get) 会通过构造器初始化ConfigurationStruct实例并存储</span></span><br><span class="line">ds.dic = di.NewContainer(di.ServiceConstructorMap&#123;</span><br><span class="line">		container.ConfigurationName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> ds.config</span><br><span class="line">		&#125;,</span><br><span class="line">		container.DeviceServiceName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> ds.deviceService</span><br><span class="line">		&#125;,</span><br><span class="line">		container.ProtocolDriverName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> ds.driver</span><br><span class="line">		&#125;,</span><br><span class="line">		container.ProtocolDiscoveryName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> ds.discovery</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="8）初始化httpServer"><a href="#8）初始化httpServer" class="headerlink" title="8）初始化httpServer"></a>8）初始化httpServer</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpServer := handlers.NewHttpServer(router, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h5 id="9）调用bootstrap-Run，传入参数如下"><a href="#9）调用bootstrap-Run，传入参数如下" class="headerlink" title="9）调用bootstrap.Run，传入参数如下"></a>9）调用bootstrap.Run，传入参数如下</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.Run(</span><br><span class="line">   ctx,</span><br><span class="line">   cancel,</span><br><span class="line">   sdkFlags,</span><br><span class="line">   ds.ServiceName,</span><br><span class="line">   common.ConfigStemDevice,</span><br><span class="line">   ds.config,</span><br><span class="line">   startupTimer,</span><br><span class="line">   ds.dic,</span><br><span class="line">   <span class="literal">true</span>,</span><br><span class="line">   []interfaces.BootstrapHandler&#123;</span><br><span class="line">      httpServer.BootstrapHandler,</span><br><span class="line">      messaging.BootstrapHandler,</span><br><span class="line">      clients.BootstrapHandler,</span><br><span class="line">      autoevent.BootstrapHandler,</span><br><span class="line">      NewBootstrap(router).BootstrapHandler,</span><br><span class="line">      autodiscovery.BootstrapHandler,</span><br><span class="line">      handlers.NewStartMessage(serviceName, serviceVersion).BootstrapHandler,</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	ctx context.Context,</span></span></span><br><span class="line"><span class="params"><span class="function">	cancel context.CancelFunc,</span></span></span><br><span class="line"><span class="params"><span class="function">	commonFlags flags.Common,</span></span></span><br><span class="line"><span class="params"><span class="function">	serviceKey <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	configStem <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	serviceConfig interfaces.Configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">	startupTimer startup.Timer,</span></span></span><br><span class="line"><span class="params"><span class="function">	dic *di.Container,</span></span></span><br><span class="line"><span class="params"><span class="function">	useSecretProvider <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	handlers []interfaces.BootstrapHandler)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	wg, deferred, _ := RunAndReturnWaitGroup(</span><br><span class="line">		ctx,</span><br><span class="line">		cancel,</span><br><span class="line">		commonFlags,</span><br><span class="line">		serviceKey,</span><br><span class="line">		configStem,</span><br><span class="line">		serviceConfig,</span><br><span class="line">		<span class="literal">nil</span>,</span><br><span class="line">		startupTimer,</span><br><span class="line">		dic,</span><br><span class="line">		useSecretProvider,</span><br><span class="line">		handlers,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> deferred()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wait for go routines to stop executing.</span></span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RunAndReturnWaitGroup引导应用程序。</span></span><br><span class="line"><span class="comment">//它加载配置并调用提供的处理程序列表。任何长时间运行的进程都应该作为go例程在处理程序中生成。</span></span><br><span class="line"><span class="comment">//处理程序应立即返回。调用所有处理程序后，此函数将返回同步。</span></span><br><span class="line"><span class="comment">//对调用方的WaitGroup引用。</span></span><br><span class="line"><span class="comment">//调用者在对返回的引用调用Wait（）之前采取任何有意义的附加操作，以等待应用程序停止（以及在各种处理程序中生成的相应goroutine完全停止）。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunAndReturnWaitGroup</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	ctx context.Context,</span></span></span><br><span class="line"><span class="params"><span class="function">	cancel context.CancelFunc,</span></span></span><br><span class="line"><span class="params"><span class="function">	commonFlags flags.Common,</span></span></span><br><span class="line"><span class="params"><span class="function">	serviceKey <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	configStem <span class="type">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	serviceConfig interfaces.Configuration,</span></span></span><br><span class="line"><span class="params"><span class="function">	configUpdated config.UpdatedStream,</span></span></span><br><span class="line"><span class="params"><span class="function">	startupTimer startup.Timer,</span></span></span><br><span class="line"><span class="params"><span class="function">	dic *di.Container,</span></span></span><br><span class="line"><span class="params"><span class="function">	useSecretProvider <span class="type">bool</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	handlers []interfaces.BootstrapHandler)</span></span> (*sync.WaitGroup, Deferred, <span class="type">bool</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	deferred := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检查该设备服务是否提供了初始化的日志客户端，如果没有就创建一个新的，并且将其存入容器</span></span><br><span class="line">	lc := container.LoggingClientFrom(dic.Get)</span><br><span class="line">    <span class="comment">// 这边设备服务启动的时候 容器返回的lc是给空的loggingClient实例，通过服务名和日志等级将其进行初始化，并且通过</span></span><br><span class="line">    <span class="comment">// Update方法这个初始化的Log客户端存入容器中</span></span><br><span class="line">	<span class="keyword">if</span> lc == <span class="literal">nil</span> &#123;</span><br><span class="line">		lc = logger.NewClient(serviceKey, models.InfoLog)</span><br><span class="line">		dic.Update(di.ServiceConstructorMap&#123;</span><br><span class="line">			container.LoggingClientInterfaceName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">				<span class="keyword">return</span> lc</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// TranslateInterruptoCancel生成一个go例程，将接收到的系统SIGTERM信号转换为取消引导上下文的cancel的调用。</span></span><br><span class="line">    <span class="comment">// 关键函数 signal.Notify(signalStream, os.Interrupt, syscall.SIGTERM) 监控系统中断信号</span></span><br><span class="line">	translateInterruptToCancel(ctx, &amp;wg, cancel)</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 读出系统环境变量 并且传入初始化的logClient</span></span><br><span class="line">	envVars := environment.NewVariables(lc)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SecretProvider 被初始化并作为处理配置的一部分放置在容器中，因为需要使用它来获取配置提供程序的访问令牌</span></span><br><span class="line">    <span class="comment">// 并且必须等到从文件加载配置后才能对其进行初始化。</span></span><br><span class="line">    <span class="comment">// commonFlags 即传入的sdkFlags</span></span><br><span class="line">    <span class="comment">// envVars 系统环境变量</span></span><br><span class="line">    <span class="comment">// startupTimer启动计时器</span></span><br><span class="line">    <span class="comment">// context</span></span><br><span class="line">    <span class="comment">// sync.WaitGroup</span></span><br><span class="line">    <span class="comment">// configUpdated config.UpdatedStream 定义接收配置更新时由 ListenForChanges 通知的流类型  此处为nil</span></span><br><span class="line">    <span class="comment">// dic 容器</span></span><br><span class="line">	configProcessor := config.NewProcessor(commonFlags, envVars, startupTimer, ctx, &amp;wg, configUpdated, dic)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// servicekey serviceName</span></span><br><span class="line">    <span class="comment">// configStem ConfigStemDevice  = &quot;edgex/devices/&quot;</span></span><br><span class="line">    <span class="comment">// serviceConfig  *config.ConfigurationStruct</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> err := configProcessor.Process(serviceKey, configStem, serviceConfig, useSecretProvider); err != <span class="literal">nil</span>&#123;</span><br><span class="line">		fatalError(err, lc)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> registryClient registry.Client</span><br><span class="line"></span><br><span class="line">	envUseRegistry, wasOverridden := envVars.UseRegistry()</span><br><span class="line">	<span class="keyword">if</span> envUseRegistry || (commonFlags.UseRegistry() &amp;&amp; !wasOverridden) &#123;</span><br><span class="line">		registryClient, err = registration.RegisterWithRegistry(</span><br><span class="line">			ctx,</span><br><span class="line">			startupTimer,</span><br><span class="line">			serviceConfig,</span><br><span class="line">			lc,</span><br><span class="line">			serviceKey,</span><br><span class="line">			dic)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fatalError(err, lc)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		deferred = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			lc.Info(<span class="string">&quot;Un-Registering service from the Registry&quot;</span>)</span><br><span class="line">			err := registryClient.Unregister()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				lc.Error(<span class="string">&quot;Unable to Un-Register service from the Registry&quot;</span>, <span class="string">&quot;error&quot;</span>, err.Error())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dic.Update(di.ServiceConstructorMap&#123;</span><br><span class="line">		container.ConfigurationInterfaceName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> serviceConfig</span><br><span class="line">		&#125;,</span><br><span class="line">		container.RegistryClientInterfaceName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> registryClient</span><br><span class="line">		&#125;,</span><br><span class="line">		container.CancelFuncName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">			<span class="keyword">return</span> cancel</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// call individual bootstrap handlers.</span></span><br><span class="line">	startedSuccessfully := <span class="literal">true</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> handlers &#123;</span><br><span class="line">		<span class="keyword">if</span> handlers[i](ctx, &amp;wg, startupTimer, dic) == <span class="literal">false</span> &#123;</span><br><span class="line">			cancel()</span><br><span class="line">			startedSuccessfully = <span class="literal">false</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;wg, deferred, startedSuccessfully</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cp *Processor)</span></span> Process(</span><br><span class="line">   serviceKey <span class="type">string</span>,</span><br><span class="line">   configStem <span class="type">string</span>,</span><br><span class="line">   serviceConfig interfaces.Configuration, <span class="comment">//serviceConfig 实现了interfaces.Configuration的所有方法</span></span><br><span class="line">   useSecretProvider <span class="type">bool</span>) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create some shorthand for frequently used items</span></span><br><span class="line">   envVars := cp.envVars</span><br><span class="line"></span><br><span class="line">   cp.overwriteConfig = cp.flags.OverwriteConfig()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果需要注册表配置信息或者需要将其推送到配置提供程序，则必须首先加载本地配置。</span></span><br><span class="line">   <span class="keyword">if</span> err := cp.loadFromFile(serviceConfig, <span class="string">&quot;service&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 使用 envVars 变量覆盖基于文件的配置。</span></span><br><span class="line">   <span class="comment">// 变量覆盖优先于所有其他变量，因此请确保在使用 config 之前之前应用它们。</span></span><br><span class="line">   overrideCount, err := envVars.OverrideConfiguration(serviceConfig)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 现在配置已经从文件加载并应用了覆盖，可以初始化秘密提供者并将其添加到 DIC，但前提是它被配置为使用。</span></span><br><span class="line">   <span class="keyword">var</span> secretProvider interfaces.SecretProvider</span><br><span class="line">   <span class="keyword">if</span> useSecretProvider &#123;</span><br><span class="line">      secretProvider, err = secret.NewSecretProvider(serviceConfig, cp.ctx, cp.startupTimer, cp.dic)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create SecretProvider: %s&quot;</span>, err.Error())</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   configProviderUrl := cp.flags.ConfigProviderUrl()</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Create new ProviderInfo and initialize it from command-line flag or Variables</span></span><br><span class="line">   configProviderInfo, err := NewProviderInfo(cp.envVars, configProviderUrl)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> configProviderInfo.UseProvider() &#123;</span><br><span class="line">   <span class="keyword">case</span> <span class="literal">true</span>:</span><br><span class="line">      <span class="keyword">var</span> accessToken <span class="type">string</span></span><br><span class="line">      <span class="keyword">var</span> getAccessToken types.GetAccessTokenCallback</span><br><span class="line"></span><br><span class="line">      <span class="comment">// secretProvider will be nil if not configured to be used. In that case, no access token required.</span></span><br><span class="line">      <span class="keyword">if</span> secretProvider != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="comment">// Define the callback function to retrieve the Access Token</span></span><br><span class="line">         getAccessToken = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">            accessToken, err = secretProvider.GetAccessToken(configProviderInfo.serviceConfig.Type, serviceKey)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(</span><br><span class="line">                  <span class="string">&quot;failed to get Configuration Provider (%s) access token: %s&quot;</span>,</span><br><span class="line">                  configProviderInfo.serviceConfig.Type,</span><br><span class="line">                  err.Error())</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cp.lc.Infof(<span class="string">&quot;Using Configuration Provider access token of length %d&quot;</span>, <span class="built_in">len</span>(accessToken))</span><br><span class="line">            <span class="keyword">return</span> accessToken, <span class="literal">nil</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         cp.lc.Info(<span class="string">&quot;Not configured to use Config Provider access token&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      configClient, err := cp.createProviderClient(serviceKey, configStem, getAccessToken, configProviderInfo.ServiceConfig())</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create Configuration Provider client: %s&quot;</span>, err.Error())</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> cp.startupTimer.HasNotElapsed() &#123;</span><br><span class="line">         <span class="keyword">if</span> err := cp.processWithProvider(</span><br><span class="line">            configClient,</span><br><span class="line">            serviceConfig,</span><br><span class="line">            overrideCount,</span><br><span class="line">         ); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            cp.lc.Error(err.Error())</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> &lt;-cp.ctx.Done():</span><br><span class="line">               <span class="keyword">return</span> errors.New(<span class="string">&quot;aborted Updating to/from Configuration Provider&quot;</span>)</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">               cp.startupTimer.SleepForInterval()</span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      cp.listenForChanges(serviceConfig, configClient)</span><br><span class="line"></span><br><span class="line">      cp.dic.Update(di.ServiceConstructorMap&#123;</span><br><span class="line">         container.ConfigClientInterfaceName: <span class="function"><span class="keyword">func</span><span class="params">(get di.Get)</span></span> <span class="keyword">interface</span>&#123;&#125; &#123;</span><br><span class="line">            <span class="keyword">return</span> configClient</span><br><span class="line">         &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">case</span> <span class="literal">false</span>:</span><br><span class="line">      cp.logConfigInfo(<span class="string">&quot;Using local configuration from file&quot;</span>, overrideCount)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Now that configuration has been loaded and overrides applied the log level can be set as configured.</span></span><br><span class="line">   err = cp.lc.SetLogLevel(serviceConfig.GetLogLevel())</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>device-sdk-go源码分析</p><p><a href="http://caixindi.github.io/EdgeX/device-sdk-go源码分析/">http://caixindi.github.io/EdgeX/device-sdk-go源码分析/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Cindy</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-12-27</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/EdgeX%E6%A6%82%E5%BF%B5/">EdgeX概念</a></div><div class="sharethis-inline-share-buttons"></div><script src="//platform-api.sharethis.com/js/sharethis.js#property=5ab6f60ace89f00013641890&amp;product=inline-share-buttons" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/EdgeX/edgex%E8%81%94%E9%82%A6%E6%8E%A8%E7%90%86%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">EdgeX联邦推理结果展示</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/EdgeX/%E6%9C%AC%E5%9C%B0docker%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/"><span class="level-item">本地docker镜像仓库部署</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/20220313221114.png" alt="Cindy"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Cindy</p><p class="is-size-6 is-block">Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth, Wuhan</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">66</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">28</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/caixindi" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/caixindi"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=1435516315&amp;website=www.oicqzone.com"><i class="fab fa-qq"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Envelope" href="mailto:caixindi98@qq.com"><i class="fas fa-envelope"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#device-sdk-go源码分析"><span class="level-left"><span class="level-item">1</span><span class="level-item">device-sdk-go源码分析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#device-sdk-go项目目录结构"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">device-sdk-go项目目录结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#cmd文件夹"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">cmd文件夹</span></span></a></li><li><a class="level is-mobile" href="#config文件夹"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">config文件夹</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#device-sdk-go流程梳理"><span class="level-left"><span class="level-item">2</span><span class="level-item">device-sdk-go流程梳理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-生成初始Driver，调用Bootstrap-传入服务名称，设备版本，以及初始Driver"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">1.生成初始Driver，调用Bootstrap:传入服务名称，设备版本，以及初始Driver</span></span></a></li><li><a class="level is-mobile" href="#2-进入Bootstrap-生成当前context以及cancel，调用Main，Main传入的参数有-服务名称，服务版本，初始驱动，context-cancel，以及Router"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">2.进入Bootstrap:生成当前context以及cancel，调用Main，Main传入的参数有:服务名称，服务版本，初始驱动，context,cancel，以及Router</span></span></a></li><li><a class="level is-mobile" href="#3-进入Main流程："><span class="level-left"><span class="level-item">2.3</span><span class="level-item">3.进入Main流程：</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1）生成定时器（根据服务名称获取系统配置的超时时间以及interval的配置，如果不存在则使用默认值）"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">1）生成定时器（根据服务名称获取系统配置的超时时间以及interval的配置，如果不存在则使用默认值）</span></span></a></li><li><a class="level is-mobile" href="#2）解析命令行参数"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">2）解析命令行参数</span></span></a></li><li><a class="level is-mobile" href="#3）设置服务名-服务名为name-os-Getenv-“EDGEX-INSTANCE-NAME”"><span class="level-left"><span class="level-item">2.3.3</span><span class="level-item">3）设置服务名 服务名为name+os.Getenv(“EDGEX_INSTANCE_NAME”)</span></span></a></li><li><a class="level is-mobile" href="#4）生成初始设备服务实例-空"><span class="level-left"><span class="level-item">2.3.4</span><span class="level-item">4）生成初始设备服务实例(空)</span></span></a></li><li><a class="level is-mobile" href="#5）初始化设备服务实例-用户必须提供服务名，其他内容由sdk内部提供"><span class="level-left"><span class="level-item">2.3.5</span><span class="level-item">5）初始化设备服务实例(用户必须提供服务名，其他内容由sdk内部提供)</span></span></a></li><li><a class="level is-mobile" href="#6）保存命令行参数"><span class="level-left"><span class="level-item">2.3.6</span><span class="level-item">6）保存命令行参数</span></span></a></li><li><a class="level is-mobile" href="#7）初始化容器（关键就是存入ServiceConstructorMap）"><span class="level-left"><span class="level-item">2.3.7</span><span class="level-item">7）初始化容器（关键就是存入ServiceConstructorMap）</span></span></a></li><li><a class="level is-mobile" href="#8）初始化httpServer"><span class="level-left"><span class="level-item">2.3.8</span><span class="level-item">8）初始化httpServer</span></span></a></li><li><a class="level is-mobile" href="#9）调用bootstrap-Run，传入参数如下"><span class="level-left"><span class="level-item">2.3.9</span><span class="level-item">9）调用bootstrap.Run，传入参数如下</span></span></a></li><li><a class="level is-mobile" href="#Process"><span class="level-left"><span class="level-item">2.3.10</span><span class="level-item">Process</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/CS217/"><span class="level-start"><span class="level-item">CS217</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/EdgeX/"><span class="level-start"><span class="level-item">EdgeX</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/categories/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Golang/"><span class="level-start"><span class="level-item">Golang</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/kubeedge/"><span class="level-start"><span class="level-item">kubeedge</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8D%8E%E4%B8%BA%E9%A1%B9%E7%9B%AE/"><span class="level-start"><span class="level-item">华为项目</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E7%B3%BB%E7%BB%9F/"><span class="level-start"><span class="level-item">智能计算系统</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/"><span class="level-start"><span class="level-item">杂七杂八</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%A1%AC%E4%BB%B6%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F/"><span class="level-start"><span class="level-item">硬件神经网络加速</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">神经网络与深度学习</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E4%B8%8E%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"><span class="level-start"><span class="level-item">计算机组成与体系结构</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CS217-Lecture/"><span class="tag">CS217 Lecture</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EdgeX%E5%B9%B3%E5%8F%B0%E6%9E%84%E5%BB%BA/"><span class="tag">EdgeX平台构建</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EdgeX%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%BB%A5%E5%8F%8A%E6%8E%A8%E7%90%86/"><span class="tag">EdgeX机器学习以及推理</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EdgeX%E6%9E%84%E5%BB%BA/"><span class="tag">EdgeX构建</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EdgeX%E6%A6%82%E5%BF%B5/"><span class="tag">EdgeX概念</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/EdgeX%E9%83%A8%E7%BD%B2/"><span class="tag">EdgeX部署</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"><span class="tag">Git使用指南</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Golang%E5%9C%A3%E7%BB%8F/"><span class="tag">Golang圣经</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="tag">Java并发编程</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E7%9F%A5%E8%AF%86%E7%82%B9/"><span class="tag">Java知识点</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux%E7%9F%A5%E8%AF%86%E7%82%B9/"><span class="tag">Linux知识点</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker%E9%83%A8%E7%BD%B2/"><span class="tag">docker部署</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubeedge/"><span class="tag">kubeedge</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubeedge-example/"><span class="tag">kubeedge example</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubeflow/"><span class="tag">kubeflow</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A5%BD%E7%9C%8B%E7%9A%84PowerShell/"><span class="tag">好看的PowerShell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BF%AB%E9%80%9F%E5%82%85%E9%87%8C%E5%8F%B6%E5%8F%98%E6%8D%A2/"><span class="tag">快速傅里叶变换</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/"><span class="tag">智能计算系统学习</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9A%97%E7%A1%85/"><span class="tag">暗硅</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B7%B1%E5%BA%A6%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84%E9%AB%98%E6%95%88%E5%A4%84%E7%90%86%EF%BC%9A%E6%95%99%E7%A8%8B%E5%92%8C%E7%BB%BC%E8%BF%B0/"><span class="tag">深度神经网络的高效处理：教程和综述</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A1%AC%E4%BB%B6%E5%8A%A0%E9%80%9F%E8%83%8C%E6%99%AF%E4%BB%A5%E5%8F%8A%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/"><span class="tag">硬件加速背景以及卷积神经网络优化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"><span class="tag">神经网络与深度学习</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%B2%97%E7%B2%92%E5%BA%A6%E5%8F%AF%E9%87%8D%E6%9E%84%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E4%B8%8EPlasticine/"><span class="tag">粗粒度可重构体系结构与Plasticine</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"><span class="tag">虚拟化</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E4%B8%8E%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"><span class="tag">计算机组成与体系结构</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BD%BB%E9%87%8F%E7%BA%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F/"><span class="tag">轻量级神经网络加速</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%AB%98%E6%80%A7%E8%83%BD%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95%E5%89%96%E6%9E%90/"><span class="tag">高性能矩阵乘法剖析</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/cindy.svg" alt="Cindy" height="28"></a><p class="is-size-7"><span>&copy; 2023 Cindy</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><img src="https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/beian.png"><a href="https://beian.miit.gov.cn" target="_blank" rel="noopener">苏ICP备2022041101-1</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>