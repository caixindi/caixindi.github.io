---
title: EdgeX实现温湿度数据读取
date: 2022-10-27
categories:
- EdgeX
tags:
- EdgeX平台构建
language: zh-CN
toc: true
---

> 在linux环境中进行测试

​	起初在win环境下可以通过使用商家提供的软件进行连接获取数据，但是在linux环境下不能连接。

​	之后通过设置树莓派eth0为静态ip，再ping 192.168.0.88 则可以发现该设备。

<!--more-->

​    静态ip配置如下：

```sh
interface eth0
static ip_address=192.168.0.2/24
static routers=192.168.0.1
static domain_name_servers=114.114.114.114
```

   利用java编写master端代码，测试连接

```java
import com.intelligt.modbus.jlibmodbus.Modbus;
import com.intelligt.modbus.jlibmodbus.exception.ModbusIOException;
import com.intelligt.modbus.jlibmodbus.master.ModbusMaster;
import com.intelligt.modbus.jlibmodbus.master.ModbusMasterFactory;
import com.intelligt.modbus.jlibmodbus.tcp.TcpParameters;

import java.net.InetAddress;
import java.net.UnknownHostException;

public class ModBusConnection {
    public final static TcpParameters tcpParameters = new TcpParameters();
    public static ModbusMaster master;
    static {
        try {
            InetAddress adress = InetAddress.getByName("192.168.0.88");
            // TCP参数设置ip地址
            tcpParameters.setHost(adress);
            // TCP设置长连接
            tcpParameters.setKeepAlive(true);
            // TCP设置端口，这里设置是默认端口502
            tcpParameters.setPort(502);
            // 创建一个主机
            master = ModbusMasterFactory.createModbusMasterTCP(tcpParameters);
            Modbus.setAutoIncrementTransactionId(true);
        } catch (UnknownHostException e) {
            e.printStackTrace();
        }
    }

    /**
     * 获取ModbusMaster
     * @return
     */
    public static ModbusMaster getModbusMaster(){
        return  master;
    }

    /**
     * 关闭ModbusMaster
     */
    public static void destoryModbusMaster(){
        if(master.isConnected()){
            try {
                master.disconnect();
            } catch (ModbusIOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

```java

import com.intelligt.modbus.jlibmodbus.Modbus;
import com.intelligt.modbus.jlibmodbus.exception.ModbusIOException;
import com.intelligt.modbus.jlibmodbus.master.ModbusMaster;
import com.intelligt.modbus.jlibmodbus.master.ModbusMasterFactory;
import com.intelligt.modbus.jlibmodbus.tcp.TcpParameters;

import java.net.InetAddress;
import java.net.UnknownHostException;

public class ModBusConnection {
    public final static TcpParameters tcpParameters = new TcpParameters();
    public static ModbusMaster master;
    static {
        try {
            InetAddress adress = InetAddress.getByName("192.168.0.88");
            // TCP参数设置ip地址
            tcpParameters.setHost(adress);
            // TCP设置长连接
            tcpParameters.setKeepAlive(true);
            // TCP设置端口，这里设置是默认端口502
            tcpParameters.setPort(502);
            // 创建一个主机
            master = ModbusMasterFactory.createModbusMasterTCP(tcpParameters);
            Modbus.setAutoIncrementTransactionId(true);
        } catch (UnknownHostException e) {
            e.printStackTrace();
        }
    }
    /**
     * 获取ModbusMaster
     * @return
     */
    public static ModbusMaster getModbusMaster(){
        return  master;
    }

    /**
     * 关闭ModbusMaster
     */
    public static void destoryModbusMaster(){
        if(master.isConnected()){
            try {
                master.disconnect();
            } catch (ModbusIOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

输出如下：

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211010170042907.png)

这是两个十六进制数，转为为十进制表示：101H=257D，也就是表示25.7摄氏度   248H=584D，也就表示湿度为58.4%

>利用EdgeX获取数据



>针对温湿度设备进行kuiper规则引擎测试

首先测试是否能获取温度数据：

```html
#get
192.168.137.100:30082/api/v2/device/name/TCP-5900/Temperature
```

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211012174344265.png)

###### 第一步：创建流

```post  http://192.168.137.100:30720/streams```

```body {"sql": "create stream demo() WITH (FORMAT=\"JSON\", TYPE=\"edgex\")"}```

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211012190949274.png)

###### 第二步：创建规则

监视来自`TCP-5900`设备的事件，如果`Temperature`读取值的平均值（20 秒内）大于 20，则向`Random-Boolean-Device`设备发送命令以停止生成随机数字（将随机生成 bool 设置为 false）。

```
#post
http://192.168.137.100:30720/rules
```

```json
{
  "id": "rule1",
  "sql": "SELECT avg(temperature) AS avg_temperature FROM demo WHERE temperature != nil and meta(deviceName)= \"TCP-5900\" GROUP BY TUMBLINGWINDOW(ss, 5) HAVING avg(temperature) > 20.0",
  "actions": [
    {
      "rest": {
        "url": "http://edgex-core-command:59882/api/v2/device/name/Random-Boolean-Device/WriteBoolValue",
        "method": "put",
        "dataTemplate": "{\"Bool\":\"false\", \"EnableRandomization_Bool\": \"false\"}",
        "sendSingle": true
      }
    },
    {
      "log":{}
    }
  ]
}
```

查看kuiper的log以及布尔型虚拟设备的值，规则生效

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211012210830736.png)

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211012210855294.png)



下面测试触发规则引擎后设置温湿度设备的高温预警值：

```json
{
  "id": "rule2",
  "sql": "SELECT avg(temperature) AS avg_temperature FROM demo WHERE temperature != nil and meta(deviceName)= \"TCP-5900\" GROUP BY TUMBLINGWINDOW(ss, 5) HAVING avg(temperature) > 20.0 ",
  "actions": [
    {
      "rest": {
        "url": "http://edgex-core-command:59882/api/v2/device/name/TCP-5900/HighTemperatureAlarm",
        "method": "put",
        "dataTemplate": "{\"HighTemperatureAlarm\":\"66\"}",
        "sendSingle": true
      }
    },
    {
      "log":{}
    }
  ]
}
```

rule2触发并且生效

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211012213342264.png)

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211012213329589.png)

下面测试当10秒内平均温度大于高温预警值的时候，发送数据给云端，规则如下：

```json
{
  "id": "rule3",
  "sql": "SELECT avg(temperature) AS avg_temperature , avg(HighTemperatureAlarm) AS avg_hightemperaturealarm FROM event WHERE temperature != nil and meta(deviceName)= \"TCP-5900\" and meta(sourceName)=\"Data\" GROUP BY TUMBLINGWINDOW(ss, 10) HAVING avg(temperature) > avg(hightemperaturealarm)  ",
  "actions": [
    {
      "rest": {
        "url": "http://10.116.169.252:8888/kuiper",
        "method": "post",
        "dataTemplate": "{\"Temperature\": \"{{.avg_temperature}}\",\"HighTemperatureAlarm\": \"{{.avg_hightemperaturealarm}}\"}",
        "sendSingle": true
      }
    },
    {
      "log":{}
    }
  ]
}
```

kuiper日志如下：

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211013171527713.png)

云端收到消息：

![](https://cxd-note-img.oss-cn-hangzhou.aliyuncs.com/typora-note-img/image-20211013171618824.png)

